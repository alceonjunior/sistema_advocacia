{% load static %}
{% load humanize %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Atualização de Valores - Processo {{ processo.numero_processo }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* CSS Mínimo Embutido */
        body {
            background-color: #f4f7f6;
            padding-bottom: 100px; /* Espaço para a barra de ações fixa */
        }
        .main-container {
            max-width: 1600px;
            margin: auto;
        }
        .card-header .bi {
            color: var(--bs-primary);
        }
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: #dc3545;
            background-image: none;
        }
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: .25rem;
            font-size: .875em;
            color: #dc3545;
        }
        .is-invalid ~ .invalid-feedback,
        td > .errorlist {
            display: block;
            color: #dc3545;
            font-size: .8em;
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .formset-row td {
            vertical-align: middle;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .formset-row .form-control, .formset-row .form-select {
            min-width: 120px;
        }
        .formset-row-add input, .formset-row-add select {
            border-color: var(--bs-primary);
        }
        .formset-row-add button {
            white-space: nowrap;
        }
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            z-index: 1020;
            backdrop-filter: blur(5px);
        }
        .summary-value {
            font-weight: 500;
        }
        .summary-value.positive { color: var(--bs-success); }
        .summary-value.negative { color: var(--bs-danger); }
        .summary-value.neutral { color: var(--bs-dark); }
    </style>
</head>
<body>
    <div class="container-fluid main-container p-3 p-md-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 d-flex align-items-center gap-2 mb-0">
                    <i class="bi bi-calculator-fill text-primary"></i> Módulo de Atualização de Valores
                </h1>
                <p class="text-muted mb-0"><strong>Processo:</strong> {{ processo }}</p>
            </div>
             <a href="{% url 'gestao:detalhe_processo' pk=processo.pk %}" class="btn btn-secondary"><i class="bi bi-arrow-left-circle"></i> Voltar ao Processo</a>
        </div>

        {% if messages %}
        <div class="messages-container mb-3">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form id="calculationForm" method="post" action="" novalidate>
            {% csrf_token %}

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-calendar3-range me-2"></i>1. Dados Globais do Cálculo</h5></div>
                        <div class="card-body">
                            {% if form.non_field_errors %}<div class="alert alert-danger p-2 small">{{ form.non_field_errors.as_text }}</div>{% endif %}
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="{{ form.descricao.id_for_label }}" class="form-label">Descrição do Cálculo</label>
                                    {% render_field form.descricao class+="form-control" %}
                                    <div class="invalid-feedback">{{ form.descricao.errors.as_text }}</div>
                                </div>
                                <div class="col-md-6" id="valor_base_container">
                                    <label for="{{ form.valor_base.id_for_label }}" class="form-label">Valor Base (sem lançamentos)</label>
                                    {% render_field form.valor_base class+="form-control" %}
                                    <div class="invalid-feedback">{{ form.valor_base.errors.as_text }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.data_inicial_global.id_for_label }}" class="form-label">Data Inicial Global</label>
                                    {% render_field form.data_inicial_global class+="form-control" %}
                                    <div class="invalid-feedback">{{ form.data_inicial_global.errors.as_text }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.data_final_global.id_for_label }}" class="form-label">Data Final Global</label>
                                    {% render_field form.data_final_global class+="form-control" %}
                                    <div class="invalid-feedback">{{ form.data_final_global.errors.as_text }}</div>
                                </div>
                                <div class="col-12 mt-4 pt-3 border-top">
                                    <div class="form-check form-switch">
                                        {% render_field form.pro_rata class+="form-check-input" %}
                                        <label class="form-check-label" for="{{ form.pro_rata.id_for_label }}">Calcular correção Pro Rata Die</label>
                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Calcula a correção proporcional aos dias do mês. Desmarque para usar o índice mensal completo."></i>
                                    </div>
                                    <div class="form-check form-switch">
                                        {% render_field form.mostrar_memoria class+="form-check-input" %}
                                        <label class="form-check-label" for="{{ form.mostrar_memoria.id_for_label }}">Mostrar memória de cálculo no resultado</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-list-ol me-2"></i>2. Lançamentos (Créditos e Débitos)</h5></div>
                        <div class="card-body">
                            {{ lancamento_formset.management_form }}
                            {% for error in lancamento_formset.non_form_errors %}<div class="alert alert-danger p-2 small">{{ error }}</div>{% endfor %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>#</th><th>Tipo</th><th>Descrição</th><th>Valor (R$)</th><th class="text-center">Ações</th></tr></thead>
                                    <tbody id="lancamento-formset-body">
                                        {% for form_item in lancamento_formset %}
                                        <tr class="formset-row" id="lancamento-row-{{ forloop.counter0 }}">
                                            <td><span class="row-counter">{{ forloop.counter }}</span>{{ form_item.id }}</td>
                                            <td>{% render_field form_item.tipo class+="form-select form-select-sm" %}{{ form_item.tipo.errors }}</td>
                                            <td>{% render_field form_item.descricao class+="form-control form-control-sm" %}{{ form_item.descricao.errors }}</td>
                                            <td>{% render_field form_item.valor class+="form-control form-control-sm text-end" %}{{ form_item.valor.errors }}</td>
                                            <td class="text-center">
                                                {% if form_item.instance.pk %}{{ form_item.DELETE }}{% endif %}
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Remover Lançamento"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="formset-row-add">
                                            <td></td>
                                            <td><select class="form-select form-select-sm" id="new-lancamento-tipo"><option value="CREDITO">Crédito</option><option value="DEBITO">Débito</option></select></td>
                                            <td><input type="text" class="form-control form-control-sm" id="new-lancamento-descricao" placeholder="Descrição do Lançamento"></td>
                                            <td><input type="text" class="form-control form-control-sm text-end" id="new-lancamento-valor" placeholder="0,00"></td>
                                            <td class="text-center"><button type="button" class="btn btn-sm btn-primary add-row" data-formset="lancamento"><i class="bi bi-plus-circle me-1"></i>Incluir</button></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="rules-tab" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="correcao-tab" data-bs-toggle="tab" data-bs-target="#correcao-pane" type="button" role="tab"><i class="bi bi-graph-up me-2"></i>Correção Monetária</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="juros-tab" data-bs-toggle="tab" data-bs-target="#juros-pane" type="button" role="tab"><i class="bi bi-percent me-2"></i>Taxas de Juros</button></li>
                            </ul>
                        </div>
                        <div class="card-body tab-content p-0" id="rules-tab-content">
                            <div class="tab-pane fade show active p-3" id="correcao-pane" role="tabpanel">
                                {{ correcao_formset.management_form }}
                                {% for error in correcao_formset.non_form_errors %}<div class="alert alert-danger p-2 small">{{ error }}</div>{% endfor %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead><tr><th>#</th><th>Índice</th><th>Início</th><th>Fim</th><th>Aplicar a</th><th class="text-center">Ações</th></tr></thead>
                                        <tbody id="correcao-formset-body">
                                            {% for form_item in correcao_formset %}
                                            <tr class="formset-row" id="correcao-row-{{ forloop.counter0 }}">
                                                <td><span class="row-counter">{{ forloop.counter }}</span>{{ form_item.id }}</td>
                                                <td>{% render_field form_item.indice class+="form-select form-select-sm" %}{{ form_item.indice.errors }}</td>
                                                <td>{% render_field form_item.data_inicio class+="form-control form-control-sm" %}{{ form_item.data_inicio.errors }}</td>
                                                <td>{% render_field form_item.data_fim class+="form-control form-control-sm" %}{{ form_item.data_fim.errors }}</td>
                                                <td>{% render_field form_item.aplicar_em class+="form-select form-select-sm aplicar-a-select" %}{{ form_item.aplicar_em.errors }}</td>
                                                <td class="text-center">{% if form_item.instance.pk %}{{ form_item.DELETE }}{% endif %}<button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="formset-row-add">
                                                <td></td>
                                                <td><select class="form-select form-select-sm" id="new-correcao-indice"><option value="INPC">INPC</option><option value="IPCA">IPCA</option><option value="IGP-M">IGP-M</option><option value="IGP-DI">IGP-DI</option><option value="SELIC">SELIC</option></select></td>
                                                <td><input type="date" class="form-control form-control-sm" id="new-correcao-data_inicio"></td>
                                                <td><input type="date" class="form-control form-control-sm" id="new-correcao-data_fim"></td>
                                                <td><select class="form-select form-select-sm aplicar-a-select" id="new-correcao-aplicar_em"></select></td>
                                                <td class="text-center"><button type="button" class="btn btn-sm btn-primary add-row" data-formset="correcao"><i class="bi bi-plus-circle me-1"></i>Incluir</button></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade p-3" id="juros-pane" role="tabpanel">
                                {{ juros_formset.management_form }}
                                {% for error in juros_formset.non_form_errors %}<div class="alert alert-danger p-2 small">{{ error }}</div>{% endfor %}
                                <div class="table-responsive">
                                    <table class="table table-sm" style="min-width: 800px;">
                                        <thead><tr><th>#</th><th>Tipo</th><th>Taxa %</th><th>Período</th><th>Capitalização</th><th>Início</th><th>Fim</th><th>Aplicar a</th><th class="text-center">Ações</th></tr></thead>
                                        <tbody id="juros-formset-body">
                                            {% for form_item in juros_formset %}
                                            <tr class="formset-row" id="juros-row-{{ forloop.counter0 }}">
                                                <td><span class="row-counter">{{ forloop.counter }}</span>{{ form_item.id }}</td>
                                                <td>{% render_field form_item.tipo class+="form-select form-select-sm" %}{{ form_item.tipo.errors }}</td>
                                                <td>{% render_field form_item.taxa class+="form-control form-control-sm text-end" %}{{ form_item.taxa.errors }}</td>
                                                <td>{% render_field form_item.periodicidade class+="form-select form-select-sm" %}{{ form_item.periodicidade.errors }}</td>
                                                <td>{% render_field form_item.capitalizacao class+="form-select form-select-sm" %}{{ form_item.capitalizacao.errors }}</td>
                                                <td>{% render_field form_item.data_inicio class+="form-control form-control-sm" %}{{ form_item.data_inicio.errors }}</td>
                                                <td>{% render_field form_item.data_fim class+="form-control form-control-sm" %}{{ form_item.data_fim.errors }}</td>
                                                <td>{% render_field form_item.aplicar_em class+="form-select form-select-sm aplicar-a-select" %}{{ form_item.aplicar_em.errors }}</td>
                                                <td class="text-center">{% if form_item.instance.pk %}{{ form_item.DELETE }}{% endif %}<button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="formset-row-add">
                                                <td></td>
                                                <td><select class="form-select form-select-sm" id="new-juros-tipo"><option value="MORATORIO">Moratório</option><option value="REMUNERATORIO">Remuneratório</option></select></td>
                                                <td><input type="text" class="form-control form-control-sm text-end" id="new-juros-taxa" placeholder="1,00"></td>
                                                <td><select class="form-select form-select-sm" id="new-juros-periodicidade"><option value="MES">Ao Mês</option><option value="DIA">Ao Dia</option><option value="ANO">Ao Ano</option></select></td>
                                                <td><select class="form-select form-select-sm" id="new-juros-capitalizacao"><option value="SIMPLES">Simples</option><option value="COMPOSTO">Composto</option></select></td>
                                                <td><input type="date" class="form-control form-control-sm" id="new-juros-data_inicio"></td>
                                                <td><input type="date" class="form-control form-control-sm" id="new-juros-data_fim"></td>
                                                <td><select class="form-select form-select-sm aplicar-a-select" id="new-juros-aplicar_em"></select></td>
                                                <td class="text-center"><button type="button" class="btn btn-sm btn-primary add-row" data-formset="juros"><i class="bi bi-plus-circle me-1"></i>Incluir</button></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-file-earmark-spreadsheet me-2"></i>5. Resumo e Pré-visualização</h5></div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span>Total de Créditos</span><span class="summary-value positive" id="summary-creditos">R$ 0,00</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span>Total de Débitos</span><span class="summary-value negative" id="summary-debitos">R$ 0,00</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Valor Líquido Base</strong><strong class="summary-value neutral" id="summary-liquido">R$ 0,00</strong></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span>Regras de Correção</span><span class="badge bg-secondary rounded-pill" id="summary-correcoes">0</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span>Regras de Juros</span><span class="badge bg-secondary rounded-pill" id="summary-juros">0</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center pt-3"><h5 class="mb-0">Valor Final Estimado</h5><h5 class="mb-0 text-primary" id="summary-final">R$ 0,00</h5></li>
                            </ul>
                            <small class="form-text text-center d-block mt-2">O valor final é uma estimativa e pode variar do cálculo exato do servidor.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar shadow-lg">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" id="btn-preview" class="btn btn-outline-info"><i class="bi bi-eye me-1"></i> Atualizar Resumo</button>
                        <button type="button" id="btn-clear" class="btn btn-outline-danger"><i class="bi bi-eraser me-1"></i> Limpar Formulário</button>
                    </div>
                    <button type="submit" id="btn-save" class="btn btn-success btn-lg">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        <i class="bi bi-save me-1"></i>
                        <span class="btn-text">Salvar Cálculo</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <template id="lancamento-template">
        <tr class="formset-row" id="lancamento-row-__prefix__">
            <td><span class="row-counter"></span><input type="hidden" name="lancamento-__prefix__-id" id="id_lancamento-__prefix__-id"></td>
            <td><select name="lancamento-__prefix__-tipo" class="form-select form-select-sm" id="id_lancamento-__prefix__-tipo"><option value="CREDITO">Crédito</option><option value="DEBITO">Débito</option></select></td>
            <td><input type="text" name="lancamento-__prefix__-descricao" class="form-control form-control-sm" id="id_lancamento-__prefix__-descricao"></td>
            <td><input type="text" name="lancamento-__prefix__-valor" class="form-control form-control-sm text-end" id="id_lancamento-__prefix__-valor"></td>
            <td class="text-center"><input type="checkbox" name="lancamento-__prefix__-DELETE" class="form-check-input d-none" id="id_lancamento-__prefix__-DELETE"><button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Remover Lançamento"><i class="bi bi-trash"></i></button></td>
        </tr>
    </template>
    <template id="correcao-template">
        <tr class="formset-row" id="correcao-row-__prefix__">
            <td><span class="row-counter"></span><input type="hidden" name="correcao-__prefix__-id" id="id_correcao-__prefix__-id"></td>
            <td><select name="correcao-__prefix__-indice" class="form-select form-select-sm" id="id_correcao-__prefix__-indice"><option value="INPC">INPC</option><option value="IPCA">IPCA</option><option value="IGP-M">IGP-M</option><option value="IGP-DI">IGP-DI</option><option value="SELIC">SELIC</option></select></td>
            <td><input type="date" name="correcao-__prefix__-data_inicio" class="form-control form-control-sm" id="id_correcao-__prefix__-data_inicio"></td>
            <td><input type="date" name="correcao-__prefix__-data_fim" class="form-control form-control-sm" id="id_correcao-__prefix__-data_fim"></td>
            <td><select name="correcao-__prefix__-aplicar_em" class="form-select form-select-sm aplicar-a-select" id="id_correcao-__prefix__-aplicar_em"></select></td>
            <td class="text-center"><input type="checkbox" name="correcao-__prefix__-DELETE" class="form-check-input d-none" id="id_correcao-__prefix__-DELETE"><button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-trash"></i></button></td>
        </tr>
    </template>
    <template id="juros-template">
         <tr class="formset-row" id="juros-row-__prefix__">
            <td><span class="row-counter"></span><input type="hidden" name="juros-__prefix__-id" id="id_juros-__prefix__-id"></td>
            <td><select name="juros-__prefix__-tipo" class="form-select form-select-sm" id="id_juros-__prefix__-tipo"><option value="MORATORIO">Moratório</option><option value="REMUNERATORIO">Remuneratório</option></select></td>
            <td><input type="text" name="juros-__prefix__-taxa" class="form-control form-control-sm text-end" id="id_juros-__prefix__-taxa"></td>
            <td><select name="juros-__prefix__-periodicidade" class="form-select form-select-sm" id="id_juros-__prefix__-periodicidade"><option value="MES">Ao Mês</option><option value="DIA">Ao Dia</option><option value="ANO">Ao Ano</option></select></td>
            <td><select name="juros-__prefix__-capitalizacao" class="form-select form-select-sm" id="id_juros-__prefix__-capitalizacao"><option value="SIMPLES">Simples</option><option value="COMPOSTO">Composto</option></select></td>
            <td><input type="date" name="juros-__prefix__-data_inicio" class="form-control form-control-sm" id="id_juros-__prefix__-data_inicio"></td>
            <td><input type="date" name="juros-__prefix__-data_fim" class="form-control form-control-sm" id="id_juros-__prefix__-data_fim"></td>
            <td><select name="juros-__prefix__-aplicar_em" class="form-select form-select-sm aplicar-a-select" id="id_juros-__prefix__-aplicar_em"></select></td>
            <td class="text-center"><input type="checkbox" name="juros-__prefix__-DELETE" class="form-check-input d-none" id="id_juros-__prefix__-DELETE"><button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-trash"></i></button></td>
        </tr>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('calculationForm');
            const formsets = {
                lancamento: { container: document.getElementById('lancamento-formset-body'), prefix: 'lancamento' },
                correcao: { container: document.getElementById('correcao-formset-body'), prefix: 'correcao' },
                juros: { container: document.getElementById('juros-formset-body'), prefix: 'juros' }
            };

            const updateTotalForms = (fsName) => {
                const { container, prefix } = formsets[fsName];
                const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
                if (totalFormsInput) totalFormsInput.value = container.children.length;
            };

            const reindexFormset = (fsName) => {
                const { container, prefix } = formsets[fsName];
                const rows = container.querySelectorAll('.formset-row');
                rows.forEach((row, index) => {
                    row.querySelector('.row-counter').textContent = index + 1;
                    row.querySelectorAll('input, select').forEach(input => {
                        for (const attr of ['name', 'id']) {
                            const oldVal = input.getAttribute(attr);
                            if (oldVal) {
                                const newVal = oldVal.replace(new RegExp(`${prefix}-\\d+-`), `${prefix}-${index}-`);
                                input.setAttribute(attr, newVal);
                            }
                        }
                    });
                });
            };

            const syncAplicarAoLancamentoOptions = () => {
                const lancamentoRows = formsets.lancamento.container.querySelectorAll('.formset-row');
                const options = [{ value: 'todos', text: 'Todos os Lançamentos' }];

                lancamentoRows.forEach((row, index) => {
                    const rowId = row.querySelector('[name$="-id"]')?.value || `new_${index}`;
                    const desc = row.querySelector(`[name$="descricao"]`).value || `Lançamento ${index + 1}`;
                    options.push({ value: rowId, text: desc });
                });

                document.querySelectorAll('.aplicar-a-select').forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    options.forEach(opt => {
                        const optionEl = document.createElement('option');
                        optionEl.value = opt.value;
                        optionEl.textContent = opt.text;
                        select.appendChild(optionEl);
                    });
                    if (Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    } else {
                        select.value = 'todos';
                    }
                });
            };

            const addRow = (fsName) => {
                const { container, prefix } = formsets[fsName];
                const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
                const newIndex = parseInt(totalFormsInput.value);
                const template = document.getElementById(`${fsName}-template`).innerHTML.replace(/__prefix__/g, newIndex);

                container.insertAdjacentHTML('beforeend', template);
                totalFormsInput.value = newIndex + 1;

                const newRow = container.querySelector(`#${fsName}-row-${newIndex}`);
                if (fsName === 'lancamento') {
                    const tipoInput = document.getElementById('new-lancamento-tipo');
                    const descInput = document.getElementById('new-lancamento-descricao');
                    const valorInput = document.getElementById('new-lancamento-valor');
                    newRow.querySelector(`[name$='tipo']`).value = tipoInput.value;
                    newRow.querySelector(`[name$='descricao']`).value = descInput.value;
                    newRow.querySelector(`[name$='valor']`).value = valorInput.value;
                    descInput.value = ''; valorInput.value = ''; descInput.focus();
                } else {
                     const addRowControls = document.querySelector(`tfoot tr[class~="formset-row-add"]`);
                     newRow.querySelectorAll('input, select').forEach(input => {
                        const fieldName = input.name.split('-').pop();
                        const sourceInput = document.getElementById(`new-${fsName}-${fieldName}`);
                        if (sourceInput) input.value = sourceInput.value;
                     });
                }
                reindexFormset(fsName);
                if (fsName === 'lancamento') syncAplicarAoLancamentoOptions();
                else syncAplicarAoLancamentoOptions();
                updatePreview();
            };

            const removeRow = (btn) => {
                const row = btn.closest('.formset-row');
                const formsetContainer = row.closest('tbody');
                const fsName = formsetContainer.id.replace('-formset-body', '');

                const deleteInput = row.querySelector(`[name$='-DELETE']`);
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.classList.add('d-none');
                } else {
                    row.remove();
                }
                reindexFormset(fsName);
                updateTotalForms(fsName); // Garante que o total de forms seja atualizado após a remoção
                if (fsName === 'lancamento') syncAplicarAoLancamentoOptions();
                updatePreview();
            };

            const normalizeNumber = (value) => parseFloat(String(value).replace(/\./g, '').replace(',', '.')) || 0;
            const formatCurrency = (value) => `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const updatePreview = () => {
                let creditos = 0, debitos = 0;
                formsets.lancamento.container.querySelectorAll('.formset-row:not(.d-none)').forEach(row => {
                    const tipo = row.querySelector('[name$="tipo"]').value;
                    const valor = normalizeNumber(row.querySelector('[name$="valor"]').value);
                    if (tipo === 'CREDITO') creditos += valor; else debitos += valor;
                });

                const liquido = creditos - debitos;
                document.getElementById('summary-creditos').textContent = formatCurrency(creditos);
                document.getElementById('summary-debitos').textContent = formatCurrency(debitos);
                document.getElementById('summary-liquido').textContent = formatCurrency(liquido);
                document.getElementById('summary-liquido').className = `summary-value ${liquido >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('summary-correcoes').textContent = formsets.correcao.container.querySelectorAll('.formset-row:not(.d-none)').length;
                document.getElementById('summary-juros').textContent = formsets.juros.container.querySelectorAll('.formset-row:not(.d-none)').length;

                const valorBaseInput = document.getElementById('id_valor_base');
                valorBaseInput.disabled = (creditos > 0 || debitos > 0);
                if (valorBaseInput.disabled) valorBaseInput.value = '';
            };

            const validateForm = () => {
                let isValid = true;
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                const checkRequired = (input) => { if (!input.value.trim()) { input.classList.add('is-invalid'); isValid = false; } };
                const checkNumber = (input) => { if (normalizeNumber(input.value) <= 0) { input.classList.add('is-invalid'); isValid = false; } };

                formsets.lancamento.container.querySelectorAll('.formset-row:not(.d-none)').forEach(row => checkNumber(row.querySelector('[name$="valor"]')));
                ['correcao', 'juros'].forEach(fsName => {
                    formsets[fsName].container.querySelectorAll('.formset-row:not(.d-none)').forEach(row => {
                        checkRequired(row.querySelector('[name$="data_inicio"]'));
                        if (fsName === 'juros') checkNumber(row.querySelector('[name$="taxa"]'));
                    });
                });
                return isValid;
            };

            const lockActions = (isSaving) => {
                const btnSave = document.getElementById('btn-save');
                btnSave.disabled = isSaving;
                btnSave.querySelector('.spinner-border').style.display = isSaving ? 'inline-block' : 'none';
                btnSave.querySelector('.btn-text').textContent = isSaving ? 'Salvando...' : 'Salvar Cálculo';
            };

            // Event Listeners
            form.addEventListener('click', (e) => {
                const addBtn = e.target.closest('.add-row');
                const removeBtn = e.target.closest('.remove-row');
                if (addBtn) addRow(addBtn.dataset.formset);
                if (removeBtn) removeRow(removeBtn);
            });
            form.addEventListener('input', updatePreview);
            document.getElementById('btn-clear').addEventListener('click', () => {
                if (confirm('Tem certeza?')) {
                    form.reset();
                    Object.values(formsets).forEach(({container}) => container.innerHTML = '');
                    Object.keys(formsets).forEach(reindexFormset);
                    syncAplicarAoLancamentoOptions(); updatePreview();
                }
            });
            document.getElementById('btn-preview').addEventListener('click', updatePreview);
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                form.querySelectorAll('input[type="text"][name$="-valor"], input[type="text"][name$="-taxa"]').forEach(input => {
                    input.value = normalizeNumber(input.value);
                });
                if (validateForm()) {
                    lockActions(true);
                    form.submit();
                } else {
                    alert('Existem erros no formulário. Corrija os campos em vermelho.');
                }
            });

            // Initial setup
            Object.keys(formsets).forEach(reindexFormset);
            syncAplicarAoLancamentoOptions();
            updatePreview();
            new bootstrap.Tooltip(document.body, { selector: '[data-bs-toggle="tooltip"]' });
        });
    </script>
</body>
</html>