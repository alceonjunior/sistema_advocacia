{% extends 'gestao/base.html' %}
{% load humanize %}

{% block title %}Painel de Processos{% endblock %}

{% block styles %}
{{ block.super }}
<style>
    /* Estilos para o estado de carregamento AJAX */
    #process-list-container.loading { opacity: 0.5; position: relative; transition: opacity 0.3s; min-height: 200px; }
    #process-list-container.loading::after {
        content: ''; position: absolute; top: 40%; left: 50%; width: 3rem; height: 3rem; margin-left: -1.5rem;
        border: 5px solid #f3f3f3; border-top: 5px solid var(--bs-primary); border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Estilos aprimorados */
    .nav-pills .nav-link { cursor: pointer; }
    .btn-collapse-filters { text-decoration: none; color: inherit; display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; }
    .btn-collapse-filters:hover { background-color: rgba(0,0,0,0.03); }
    .btn-collapse-filters .bi-chevron-down { transition: transform 0.3s ease; }
    .btn-collapse-filters[aria-expanded="true"] .bi-chevron-down { transform: rotate(180deg); }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2"><i class="bi bi-folder-fill text-primary"></i> Painel de Processos</h1>
    <a href="{% url 'gestao:adicionar_processo' %}" class="btn btn-primary"><i class="bi bi-plus-circle-fill me-1"></i> Adicionar Novo Processo</a>
</div>

<ul class="nav nav-pills nav-fill mb-4" id="status-pills">
    <li class="nav-item p-1"><a class="nav-link" data-status="">Todos <span class="badge bg-secondary rounded-pill">{{ stats.total }}</span></a></li>
    <li class="nav-item p-1"><a class="nav-link" data-status="ATIVO">Ativos <span class="badge bg-primary rounded-pill">{{ stats.ativos }}</span></a></li>
    <li class="nav-item p-1"><a class="nav-link" data-status="SUSPENSO">Suspensos <span class="badge bg-warning text-dark rounded-pill">{{ stats.suspensos }}</span></a></li>
    <li class="nav-item p-1"><a class="nav-link" data-status="ARQUIVADO">Arquivados <span class="badge bg-dark rounded-pill">{{ stats.arquivados }}</span></a></li>
</ul>

<div class="card mb-4 shadow-sm">
    <a href="#collapse-filters" class="btn-collapse-filters" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapse-filters">
        <h5 class="mb-0 d-flex justify-content-between align-items-center">
            <span class="d-flex align-items-center gap-2"><i class="bi bi-funnel-fill"></i> Filtros e Busca</span>
            <i class="bi bi-chevron-down"></i>
        </h5>
    </a>
    <div class="collapse" id="collapse-filters">
        <div class="card-body border-top">
            <form id="filter-form" class="row g-3 align-items-end">
                <div class="col-md-6 col-lg-4">{{ filter.form.busca_geral.label_tag }} {{ filter.form.busca_geral }}</div>
                <div class="col-md-6 col-lg-2">{{ filter.form.status_processo.label_tag }} {{ filter.form.status_processo }}</div>
                <div class="col-md-6 col-lg-2">{{ filter.form.tipo_acao__area.label_tag }} {{ filter.form.tipo_acao__area }}</div>
                <div class="col-md-6 col-lg-2">{{ filter.form.advogado_responsavel.label_tag }} {{ filter.form.advogado_responsavel }}</div>
                <div class="col-md-6 col-lg-2">{{ filter.form.ordering.label_tag }} {{ filter.form.ordering }}</div>
            </form>
        </div>
        <div class="card-footer text-end">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-clear-filters"><i class="bi bi-eraser-fill me-1"></i> Limpar Filtros</button>
        </div>
    </div>
</div>

<div id="process-list-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% include 'gestao/partials/_lista_processos_partial.html' %}
</div>

{% endblock %}


{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Cache dos elementos do DOM
    const filterForm = document.getElementById('filter-form');
    const processListContainer = document.getElementById('process-list-container');
    const statusPillsContainer = document.getElementById('status-pills');
    const statusSelect = document.getElementById('id_status_processo');
    const clearFiltersBtn = document.getElementById('btn-clear-filters');
    let debounceTimer;

    function updateProcessList() {
        processListContainer.classList.add('loading');
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        const url = `{% url 'gestao:lista_processos' %}?${params.toString()}`;
        history.pushState(null, '', url);

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => { processListContainer.innerHTML = html; })
            .finally(() => { processListContainer.classList.remove('loading'); });
    }

    function syncPills(selectedValue) {
        statusPillsContainer.querySelectorAll('.nav-link').forEach(pill => {
            pill.classList.toggle('active', pill.dataset.status === selectedValue);
        });
    }

    // Listener para os filtros de texto e select
    if (filterForm) {
        // Debounce para campos de texto, para não buscar a cada tecla digitada
        filterForm.addEventListener('input', function(e) {
             if (e.target.matches('input[type="text"]')) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateProcessList, 400);
             }
        });
        // Busca imediata para selects
        filterForm.addEventListener('change', function(e){
            if (e.target.matches('select')) {
                if (e.target.id === 'id_status_processo') {
                    syncPills(e.target.value);
                }
                updateProcessList();
            }
        });
    }

    // ==========================================================
    // ↓↓↓ CORREÇÃO PARA O CLIQUE NOS TOTALIZADORES (PÍLULAS) ↓↓↓
    // ==========================================================
    if (statusPillsContainer) {
        statusPillsContainer.addEventListener('click', function(e) {
            const pill = e.target.closest('.nav-link');
            if (pill) {
                e.preventDefault();
                const status = pill.dataset.status;

                // 1. Atualiza o valor do select no formulário
                statusSelect.value = status;

                // 2. Chama diretamente a função que atualiza a aparência das pílulas
                syncPills(status);

                // 3. Chama diretamente a função que busca os processos com o novo filtro
                updateProcessList();
            }
        });
    }

    // Lógica para o botão "Limpar Filtros"
    if(clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            filterForm.reset();
            statusSelect.value = 'ATIVO';
            syncPills('ATIVO');
            updateProcessList();
        });
    }

    // Sincronização inicial no carregamento da página
    if (statusSelect) {
        syncPills(statusSelect.value || 'ATIVO');
    }
});
</script>
{% endblock %}