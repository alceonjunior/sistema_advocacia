{% load static %}
<!doctype html>
<html lang="pt-br" data-bs-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Advocacia Manager{% endblock %}</title>

    {# --- ESTILOS CSS (Mantidos) --- #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    {% block styles %}{% endblock %}
</head>
<body class="bg-light">

    <!-- ========================================================== -->
    <!-- ↓↓↓ O BLOCO <nav> FOI SUBSTITUÍDO POR ESTE <header> APRIMORADO ↓↓↓ -->
    <!-- ========================================================== -->
    <header class="navbar navbar-expand-lg bg-white border-bottom shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="{% url 'gestao:home' %}">
                <i class="bi bi-briefcase-fill"></i>
                Advocacia Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="main-navbar">
                <!-- Itens de Navegação Principais (à esquerda) com Ícones -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="{% url 'gestao:dashboard' %}"><i class="bi bi-grid-1x2-fill me-1"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'gestao:lista_clientes' %}"><i class="bi bi-people-fill me-1"></i>Clientes</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'gestao:lista_processos' %}"><i class="bi bi-folder-fill me-1"></i>Processos</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'gestao:lista_servicos' %}"><i class="bi bi-briefcase-fill me-1"></i>Serviços</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'gestao:painel_financeiro' %}">
                            <i class="bi bi-wallet2 me-1"></i>Financeiro
                        </a>
                    </li>

                    <li class="nav-item"><a class="nav-link" href="{% url 'gestao:lista_modelos' %}"><i class="bi bi-file-earmark-text-fill me-1"></i>Modelos</a></li>
                </ul>

                <!-- Menu do Usuário e Configurações (à direita) -->
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle fs-5"></i>
                            <span>{{ request.user.get_full_name|default:request.user.username }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'gestao:configuracoes' %}"><i class="bi bi-gear-fill me-2"></i>Configurações</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">{% csrf_token %}</form>
                                <a class="dropdown-item text-danger" href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                                    <i class="bi bi-box-arrow-right me-2"></i>Sair
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </header>


    <main class="container my-4">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    <!-- ==================================================================================== -->
    <!-- SEU CÓDIGO DE MODAIS FOI MANTIDO EXATAMENTE IGUAL -->
    <!-- ==================================================================================== -->
    <div class="modal fade" id="adicionarServicoModal" tabindex="-1" aria-labelledby="adicionarServicoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="adicionarServicoModalLabel">Adicionar Novo Serviço</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addServicoForm" action="{% url 'gestao:adicionar_servico' %}" method="post" novalidate>
                    {% csrf_token %}
                    <div class="modal-body">
                        <div id="servicoFormErrors" class="alert alert-danger d-none p-2 small"></div>

                        <h5 class="mb-3 border-bottom pb-2">Dados do Serviço</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" for="{{ form_servico.cliente.id_for_label }}">Cliente</label>
                                <div class="input-group">
                                    {{ form_servico.cliente }}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#adicionarClienteModal" title="Adicionar Novo Cliente">+</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="{{ form_servico.tipo_servico.id_for_label }}">Tipo de Serviço</label>
                                <div class="input-group">
                                    {{ form_servico.tipo_servico }}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#adicionarTipoServicoModal" title="Adicionar Novo Tipo">+</button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="{{ form_servico.descricao.id_for_label }}" class="form-label">{{ form_servico.descricao.label }}</label>
                                {{ form_servico.descricao }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form_servico.responsavel.id_for_label }}" class="form-label">{{ form_servico.responsavel.label }}</label>
                                {{ form_servico.responsavel }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form_servico.prazo.id_for_label }}" class="form-label">{{ form_servico.prazo.label }}</label>
                                {{ form_servico.prazo }}
                            </div>
                        </div>

                        <div class="form-check form-switch my-3">
                            {{ form_servico.recorrente }}
                            <label class="form-check-label" for="{{ form_servico.recorrente.id_for_label }}">É um serviço recorrente (assessoria, etc)?</label>
                        </div>

                        <hr class="my-4">

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="toggleContrato">
                            <label class="form-check-label" for="toggleContrato"><strong>Adicionar Contrato de Honorários</strong></label>
                        </div>

                        <div id="contrato-fields" style="display: none;">
                            <h5 class="mb-3 border-bottom pb-2">Detalhes Financeiros (Honorários)</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="{{ form_contrato.descricao.id_for_label }}" class="form-label">{{ form_contrato.descricao.label }}</label>
                                    {{ form_contrato.descricao }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form_contrato.valor_pagamento_fixo.id_for_label }}" class="form-label">{{ form_contrato.valor_pagamento_fixo.label }}</label>
                                    {{ form_contrato.valor_pagamento_fixo }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form_contrato.qtde_pagamentos_fixos.id_for_label }}" class="form-label">{{ form_contrato.qtde_pagamentos_fixos.label }}</label>
                                    {{ form_contrato.qtde_pagamentos_fixos }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form_contrato.data_primeiro_vencimento.id_for_label }}" class="form-label">{{ form_contrato.data_primeiro_vencimento.label }}</label>
                                    {{ form_contrato.data_primeiro_vencimento }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form_contrato.percentual_exito.id_for_label }}" class="form-label">{{ form_contrato.percentual_exito.label }}</label>
                                    {{ form_contrato.percentual_exito }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Serviço</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adicionarTipoServicoModal" tabindex="-1" aria-labelledby="adicionarTipoServicoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Adicionar Novo Tipo de Serviço</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addTipoServicoForm" method="post" action="{% url 'gestao:adicionar_tipo_servico_modal' %}"
                  data-ajax-form="true"
                  data-target-select="#id_tipo_servico"
                  novalidate>
                    {% csrf_token %}
                    <div class="modal-body">
                        {{ form_tipo_servico.as_p }}
                        <div id="tipoServicoFormErrors" class="alert alert-danger d-none p-2 small"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Tipo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# --- SCRIPTS GLOBAIS (Mantidos) --- #}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

{% block javascript %}
<script>
// Usando a sintaxe do jQuery, que já está carregado na sua página.
$(function() {

    // --- SCRIPT DE DESTAQUE DO MENU ATIVO ---
    const currentPath = window.location.pathname;
    const navLinks = $('#main-navbar .nav-link');
    let hasActiveLink = false;

    navLinks.each(function() {
        const link = $(this);
        const linkPath = link.attr('href');

        // Verifica se a URL atual começa com a URL do link (para destacar páginas filhas)
        if (linkPath && linkPath !== '{% url "gestao:home" %}' && currentPath.startsWith(linkPath)) {
            navLinks.removeClass('active fw-bold').removeAttr('aria-current');
            link.addClass('active fw-bold').attr('aria-current', 'page');
            hasActiveLink = true;
            return false; // Interrompe o loop
        }
    });

    // Se nenhum link foi ativado, ativa o do Dashboard (para a página inicial)
    if (!hasActiveLink && (currentPath === '{% url "gestao:home" %}' || currentPath === '{% url "gestao:dashboard" %}')) {
        $('#main-navbar .nav-link[href="{% url "gestao:dashboard" %}"]').addClass('active fw-bold');
    }

    // --- INICIALIZAÇÃO CORRETA DO SELECT2 NOS MODAIS ---
    const servicoModalEl = document.getElementById('adicionarServicoModal');
    if (servicoModalEl) {
        // Ouve o evento que o Bootstrap dispara QUANDO o modal termina de ser exibido
        $(servicoModalEl).on('shown.bs.modal', function () {
            // Só agora, com o modal visível, inicializamos o Select2
            $('#adicionarServicoModal #id_cliente, #adicionarServicoModal #id_tipo_servico, #adicionarServicoModal #id_responsavel').select2({
                theme: "bootstrap-5",
                width: '100%',
                language: "pt-BR",
                // Esta linha é crucial para que a caixa de busca funcione dentro do modal
                dropdownParent: $('#adicionarServicoModal')
            });
        });
    }

    // --- MANIPULADOR DE SUBMISSÃO AJAX PARA FORMULÁRIOS EM MODAIS ---
    // Este código intercepta o envio de formulários que têm o atributo data-ajax-form="true"
    $(document).on('submit', 'form[data-ajax-form="true"]', function(event) {
        event.preventDefault();

        const form = $(this);
        const formData = new FormData(this);
        const submitButton = form.find('button[type="submit"]');
        const errorDiv = form.find('.alert-danger');
        const targetSelectId = form.data('target-select');

        submitButton.prop('disabled', true);
        if (errorDiv.length) errorDiv.addClass('d-none').html('');

        fetch(form.attr('action'), {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const item = data.cliente || data;
                if (targetSelectId && item.pk && item.nome) {
                    const selectEl = $(targetSelectId);
                    if (selectEl.length) {
                        const newOption = new Option(item.nome, item.pk, true, true);
                        selectEl.append(newOption).trigger('change');
                    }
                }

                const modalEl = form.closest('.modal');
                if (modalEl.length) {
                    bootstrap.Modal.getInstance(modalEl[0]).hide();
                }
                form[0].reset();

                // Dispara um evento global para que outras partes da aplicação possam reagir
                document.dispatchEvent(new CustomEvent('itemAdicionado', {
                    detail: { tipo: data.cliente ? 'cliente' : 'tipo_servico', dados: item }
                }));
            } else if (data.errors) {
                // Função para renderizar os erros no formulário
                let errorHtml = '<ul class="mb-0 list-unstyled">';
                for (const field in data.errors) {
                    data.errors[field].forEach(error => {
                        const messageText = (typeof error === 'object' && error.message) ? error.message : error;
                        errorHtml += `<li><small>${messageText}</small></li>`;
                    });
                }
                errorHtml += '</ul>';
                if(errorDiv.length) errorDiv.html(errorHtml).removeClass('d-none');
            }
        })
        .catch(error => {
            console.error('Erro de comunicação:', error);
            if(errorDiv.length) {
                errorDiv.html('Ocorreu um erro de comunicação. Tente novamente.').removeClass('d-none');
            }
        })
        .finally(() => {
            submitButton.prop('disabled', false);
        });
    });

    // --- SCRIPT PARA ALERTAS DESAPARECEREM ---
    // Adicionado o script para fechar alertas automaticamente após 5 segundos
    setTimeout(function() {
        $('.alert.alert-dismissible').each(function() {
            var alert = new bootstrap.Alert(this);
            alert.close();
        });
    }, 5000); // 5000ms = 5 segundos

});
</script>
{% endblock %}



</body>
</html>