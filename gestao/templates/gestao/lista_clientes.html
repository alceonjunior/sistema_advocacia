{% extends 'gestao/base.html' %}

{% block title %}Gestão de Clientes{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    .client-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .client-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
    }
    .avatar-circle {
        height: 40px;
        width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    #client-list-container.loading {
        opacity: 0.5;
        position: relative;
        transition: opacity 0.3s;
    }
    #client-list-container.loading::after {
        content: '';
        position: absolute;
        top: 40%;
        left: 50%;
        width: 3rem;
        height: 3rem;
        margin-left: -1.5rem;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0d6efd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2"><i class="bi bi-people-fill text-primary"></i> Gestão de Clientes</h1>
    <button type="button" class="btn btn-primary btn-adicionar"><i class="bi bi-plus-circle"></i> Adicionar Cliente</button>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form id="filter-form" class="row g-3 align-items-end">
            <div class="col-md-9">
                <label for="{{ filter.form.busca_geral.id_for_label }}" class="form-label">Buscar por Nome ou CPF/CNPJ</label>
                {{ filter.form.busca_geral }}
            </div>
            <div class="col-md-3">
                <label for="{{ filter.form.tipo_pessoa.id_for_label }}" class="form-label">Tipo de Pessoa</label>
                {{ filter.form.tipo_pessoa }}
            </div>
        </form>
    </div>
</div>

<div id="client-list-container" class="row">
    {% include 'gestao/partials/_lista_clientes_partial.html' %}
</div>

<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="clienteModalLabel">Adicionar Cliente</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="clienteForm" method="post" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    {{ form.as_p }}
                    <div id="form-errors" class="text-danger small mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="confirmDeleteModalLabel">Confirmar Exclusão</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Você tem certeza que deseja excluir o cliente <strong id="clienteNomeDelete"></strong>?</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Sim, Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- SELEÇÃO DE ELEMENTOS ---
    const clienteModal = new bootstrap.Modal(document.getElementById('clienteModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    const clienteForm = document.getElementById('clienteForm');
    const modalLabel = document.getElementById('clienteModalLabel');
    const clientListContainer = document.getElementById('client-list-container');
    const formErrors = document.getElementById('form-errors');
    const telefoneInput = $('#clienteModal #id_telefone_principal');

    // --- LÓGICA DE FILTRAGEM DINÂMICA ---
    const filterForm = document.getElementById('filter-form');
    const searchInput = filterForm.querySelector('input[name="busca_geral"]');
    const typeSelect = filterForm.querySelector('select[name="tipo_pessoa"]');
    let debounceTimer;

    function updateClientList() {
        clientListContainer.classList.add('loading');
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        const url = `{% url 'lista_clientes' %}?${params.toString()}`;
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                clientListContainer.innerHTML = html;
            })
            .finally(() => {
                clientListContainer.classList.remove('loading');
            });
    }

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updateClientList, 400);
    });
    typeSelect.addEventListener('change', updateClientList);

    // --- LÓGICA PARA ABRIR OS MODAIS ---

    // Botão "+ Adicionar Cliente"
    document.querySelector('.btn-adicionar').addEventListener('click', function () {
        modalLabel.textContent = 'Adicionar Cliente';
        clienteForm.action = "{% url 'adicionar_cliente' %}";
        clienteForm.reset();
        formErrors.innerHTML = '';
        telefoneInput.mask('(00) 0000-00009');
        clienteModal.show();
    });

    // Botões "Editar" e "Excluir" (usando delegação de eventos)
    clientListContainer.addEventListener('click', function (e) {
        const editButton = e.target.closest('.btn-editar');
        const deleteButton = e.target.closest('.btn-excluir');

        if (editButton) {
            e.preventDefault();
            const pk = editButton.dataset.pk;
            formErrors.innerHTML = '';
            fetch(`/clientes/${pk}/json/`)
                .then(response => response.json())
                .then(data => {
                    modalLabel.textContent = 'Editar Cliente';
                    clienteForm.action = `/clientes/${pk}/salvar/`;
                    for (const key in data) {
                        if (clienteForm.elements[key]) {
                            clienteForm.elements[key].value = data[key];
                        }
                    }
                    telefoneInput.mask('(00) 0000-00009');
                    clienteModal.show();
                });
        }

        if (deleteButton) {
            e.preventDefault();
            const pk = deleteButton.dataset.pk;
            const nome = deleteButton.dataset.nome;
            document.getElementById('clienteNomeDelete').textContent = nome;
            document.getElementById('deleteForm').action = `/clientes/${pk}/excluir/`;
            deleteModal.show();
        }
    });

    // --- LÓGICA PARA ENVIAR OS FORMULÁRIOS VIA AJAX ---

    // Envio do formulário Salvar (Adicionar/Editar)
    clienteForm.addEventListener('submit', function (e) {
        e.preventDefault();
        telefoneInput.unmask();
        const formData = new FormData(clienteForm);
        telefoneInput.mask('(00) 0000-00009');

        fetch(clienteForm.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                clienteModal.hide();
                updateClientList(); // Atualiza a lista dinamicamente
            } else {
                let errorHtml = '<ul class="list-unstyled">';
                for (const field in data.errors) {
                    data.errors[field].forEach(error => {
                        errorHtml += `<li>${field}: ${error.message}</li>`;
                    });
                }
                errorHtml += '</ul>';
                formErrors.innerHTML = errorHtml;
            }
        });
    });

    // Envio do formulário Excluir
    document.getElementById('deleteForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                deleteModal.hide();
                updateClientList(); // Atualiza a lista dinamicamente
            } else {
                alert('Erro ao excluir: ' + data.message);
            }
        });
    });
});
</script>
{% endblock %}