{% extends 'gestao/base.html' %}
{% load static %}

{% block title %}Painel de Clientes{% endblock %}

{% block styles %}
<style>
    /* Estilo para o efeito de carregamento da lista */
    #client-list-container.loading {
        opacity: 0.5;
        position: relative;
        transition: opacity 0.3s;
        min-height: 200px;
        pointer-events: none;
    }

    #client-list-container.loading::after {
        content: '';
        position: absolute;
        top: 40%;
        left: 50%;
        width: 3rem;
        height: 3rem;
        margin-left: -1.5rem;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--bs-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Garante o scroll no modal de cliente */
    #addClienteModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2">
        <i class="bi bi-people-fill text-primary"></i> Painel de Clientes
    </h1>
    <a href="{% url 'gestao:adicionar_cliente_page' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle-fill me-1"></i> Adicionar Novo Cliente
    </a>

</div>

<div class="row mb-4">
    <div class="col-6 col-lg-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted small">TOTAL DE CLIENTES</h6>
                <div class="fs-2 fw-bold">{{ stats.total }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted small">COM PROCESSOS ATIVOS</h6>
                <div class="fs-2 fw-bold text-primary">{{ stats.com_processos_ativos }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted small">COM SERVIÇOS ATIVOS</h6>
                <div class="fs-2 fw-bold text-info">{{ stats.com_servicos_ativos }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <h6 class="text-muted small">CLIENTES ATIVOS (TOTAL)</h6>
                <div class="fs-2 fw-bold text-success">{{ stats.total_ativos }}</div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header">
        <h5 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-funnel-fill"></i> Filtros, Busca e Ordenação
        </h5>
    </div>
    <div class="card-body">
        <form id="filter-form" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="{{ filter.form.busca_geral.id_for_label }}" class="form-label">{{ filter.form.busca_geral.label }}</label>
                {{ filter.form.busca_geral }}
            </div>
            <div class="col-md-2">
                <label for="{{ filter.form.tipo_pessoa.id_for_label }}" class="form-label">{{ filter.form.tipo_pessoa.label }}</label>
                {{ filter.form.tipo_pessoa }}
            </div>
            <div class="col-md-3">
                <label for="{{ filter.form.status_casos.id_for_label }}" class="form-label">{{ filter.form.status_casos.label }}</label>
                {{ filter.form.status_casos }}
            </div>
            <div class="col-md-3">
                <label for="{{ filter.form.ordering.id_for_label }}" class="form-label">{{ filter.form.ordering.label }}</label>
                {{ filter.form.ordering }}
            </div>
        </form>
    </div>
</div>

<div id="client-list-container">
    {% include 'gestao/partials/_lista_clientes_partial.html' %}
</div>

{% include 'gestao/partials/_modal_adicionar_cliente.html' with form=form %}

{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterForm = document.getElementById('filter-form');
    const clientListContainer = document.getElementById('client-list-container');
    let debounceTimer;
    let tooltipList = []; // Para gerenciar os tooltips dinamicamente

    // Função para inicializar ou atualizar os tooltips
    function initializeTooltips() {
        tooltipList.forEach(t => t.dispose());
        const tooltipTriggerList = [].slice.call(clientListContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // Função para atualizar a lista de clientes via AJAX
    function updateClientList() {
        clientListContainer.classList.add('loading');
        const params = new URLSearchParams(new FormData(filterForm));
        const url = `{% url 'gestao:lista_clientes' %}?${params.toString()}`;
        history.pushState(null, '', url);

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                clientListContainer.innerHTML = html;
                initializeTooltips(); // Re-inicializa os tooltips no novo conteúdo
            })
            .finally(() => {
                clientListContainer.classList.remove('loading');
            });
    }

    // Adiciona os "ouvintes" aos campos do formulário de filtro
    if (filterForm) {
        filterForm.querySelectorAll('input, select').forEach(input => {
            const eventType = input.tagName.toLowerCase() === 'select' ? 'change' : 'input';
            input.addEventListener(eventType, function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateClientList, 400); // Debounce para evitar muitas requisições
            });
        });
    }

    // Atualiza a lista quando um novo cliente é salvo pelo modal
    document.addEventListener('clienteSalvo', function(e) {
        updateClientList();
    });

    // Lógica para EXCLUSÃO de cliente via AJAX com DELEGAÇÃO DE EVENTO
    clientListContainer.addEventListener('click', function(e) {
        const deleteButton = e.target.closest('.btn-excluir-cliente');

        if (deleteButton) {
            e.preventDefault();

            const url = deleteButton.dataset.url;
            const nomeCliente = deleteButton.dataset.nome;
            const csrfToken = '{{ csrf_token }}';
            const clientCard = deleteButton.closest('.client-card');

            // === MENSAGEM DE CONFIRMAÇÃO APRIMORADA ===
            const confirmacao = confirm(`Você está prestes a excluir o cliente: ${nomeCliente}\n\nEsta ação é permanente e não poderá ser desfeita.\nDeseja continuar?`);

            if (confirmacao) {
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (clientCard) {
                            clientCard.style.transition = 'opacity 0.5s';
                            clientCard.style.opacity = '0';
                            setTimeout(() => clientCard.remove(), 500); // Remove o card após a animação
                        }
                    } else {
                        alert(`Erro ao excluir: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro de comunicação ao tentar excluir o cliente.');
                });
            }
        }
    });

    // Inicializa os tooltips no carregamento inicial da página
    initializeTooltips();
});
</script>
{% endblock %}
