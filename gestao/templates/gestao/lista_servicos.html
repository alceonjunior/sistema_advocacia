{% extends 'gestao/base.html' %}
{% load static humanize %}

{% block title %}Painel de Serviços{% endblock %}

{% block styles %}
{{ block.super }}
<style>
    /* Efeito de carregamento para a atualização AJAX */
    #service-list-container.loading { opacity: 0.5; position: relative; transition: opacity 0.3s; min-height: 200px; }
    #service-list-container.loading::after {
        content: ''; position: absolute; top: 40%; left: 50%; width: 3rem; height: 3rem; margin-left: -1.5rem;
        border: 5px solid #f3f3f3; border-top: 5px solid var(--bs-primary); border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2">
        <i class="bi bi-briefcase-fill text-primary"></i> Painel de Serviços Extrajudiciais
    </h1>
    <a href="{% url 'gestao:adicionar_servico' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle-fill me-1"></i> Adicionar Novo Serviço
    </a>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
        <a href="#collapse-filters" class="text-decoration-none text-dark" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapse-filters">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center gap-2"><i class="bi bi-funnel-fill"></i> Filtros e Busca</span>
                <i class="bi bi-chevron-down"></i>
            </h5>
        </a>
    </div>
    <div class="collapse" id="collapse-filters">
        <div class="card-body border-top">
            <form id="filter-form" class="row g-3 align-items-end">
                <div class="col-md-5">{{ filter.form.busca_geral.label_tag }} {{ filter.form.busca_geral }}</div>
                <div class="col-md-4">{{ filter.form.tipo_servico.label_tag }} {{ filter.form.tipo_servico }}</div>
                <div class="col-md-3">{{ filter.form.concluido.label_tag }} {{ filter.form.concluido }}</div>
            </form>
        </div>
        <div class="card-footer text-end">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-clear-filters"><i class="bi bi-eraser-fill me-1"></i> Limpar Filtros</button>
        </div>
    </div>
</div>

<div id="service-list-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% include 'gestao/partials/_lista_servicos_partial.html' %}
</div>

{% endblock %}


{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterForm = document.getElementById('filter-form');
    const serviceListContainer = document.getElementById('service-list-container');
    const clearFiltersBtn = document.getElementById('btn-clear-filters');
    let debounceTimer;

    function updateServiceList() {
        serviceListContainer.classList.add('loading');
        const params = new URLSearchParams(new FormData(filterForm));
        const url = `{% url 'gestao:lista_servicos' %}?${params.toString()}`;
        history.pushState(null, '', url);

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => { serviceListContainer.innerHTML = html; })
            .finally(() => { serviceListContainer.classList.remove('loading'); });
    }

    if (filterForm) {
        filterForm.addEventListener('input', function(e) {
            if (e.target.matches('input')) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateServiceList, 400);
            }
        });
        filterForm.addEventListener('change', function(e){
            if (e.target.matches('select')) {
                updateServiceList();
            }
        });
    }

    if(clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            filterForm.reset();
            updateServiceList();
        });
    }
});
</script>
{% endblock %}