{% extends 'gestao/base.html' %}

{% block title %}Gestão de Serviços{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* Estilos para a aparência aprimorada dos cards e do estado de carregamento */
    .service-card { border-left: 5px solid #dee2e6; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .service-card:hover { transform: translateY(-4px); box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); }
    .status-andamento { border-left-color: #0d6efd; }
    .status-concluido { border-left-color: #198754; }
    .status-recorrente { border-left-color: #0dcaf0; }
    .status-inativo { border-left-color: #dc3545; }
    .status-prazo-block { text-align: center; padding: 1rem; border-left: 1px solid #eee; }
    #service-list-container.loading { opacity: 0.5; position: relative; transition: opacity 0.3s; }
    #service-list-container.loading::after { content: ''; position: absolute; top: 40%; left: 50%; width: 3rem; height: 3rem; margin-left: -1.5rem; border: 5px solid #f3f3f3; border-top: 5px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 992px) { .status-prazo-block { border-left: none; border-top: 1px solid #eee; margin-top: 1rem; text-align: left; padding: 1rem 0 0 0; } }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2"><i class="bi bi-briefcase-fill text-primary"></i> Gestão de Serviços</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#adicionarServicoModal">+ Adicionar Novo Serviço</button>
</div>

<div class="card mb-4">
    <div class="card-header"><h5 class="mb-0 d-flex align-items-center gap-2"><i class="bi bi-funnel-fill"></i> Filtros e Busca</h5></div>
    <div class="card-body">
        <form id="filter-form" class="row g-3 align-items-end">
            <div class="col-lg-4 col-md-12">{{ filter.form.busca_geral.label_tag }}{{ filter.form.busca_geral }}</div>
            <div class="col-lg-2 col-md-6">{{ filter.form.cliente.label_tag }}{{ filter.form.cliente }}</div>
            <div class="col-lg-2 col-md-6">{{ filter.form.tipo_servico.label_tag }}{{ filter.form.tipo_servico }}</div>
            <div class="col-lg-2 col-md-6">{{ filter.form.data_inicio_depois_de.label_tag }}{{ filter.form.data_inicio_depois_de }}</div>
            <div class="col-lg-2 col-md-6">{{ filter.form.data_inicio_antes_de.label_tag }}{{ filter.form.data_inicio_antes_de }}</div>
        </form>
    </div>
</div>

<div id="service-list-container">
    {% include 'gestao/partials/_lista_servicos_partial.html' %}
</div>
{% endblock %}


{% block javascript %}
    {# ====================================================================== #}
    {# === CORREÇÃO ESSENCIAL: Inclui o javascript do template pai (base.html) #}
    {# ====================================================================== #}
    {{ block.super }}

    {# Agora, adiciona o javascript específico desta página #}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.getElementById('filter-form');
        const serviceListContainer = document.getElementById('service-list-container');
        let debounceTimer;

        // A função de filtro dinâmico não precisa ser alterada
        function updateServiceList() {
            serviceListContainer.classList.add('loading');
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            const url = `{% url 'lista_servicos' %}?${params.toString()}`;

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.text())
                .then(html => {
                    serviceListContainer.innerHTML = html;
                })
                .finally(() => {
                    serviceListContainer.classList.remove('loading');
                });
        }

        // Os eventos de filtro também não precisam ser alterados
        if (filterForm) {
            filterForm.querySelectorAll('input, select').forEach(input => {
                const eventType = input.tagName.toLowerCase() === 'select' ? 'change' : 'input';
                input.addEventListener(eventType, function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(updateServiceList, 400);
                });
            });
        }
    });
    </script>
{% endblock %}