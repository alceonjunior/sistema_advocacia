{% extends 'gestao/base.html' %}

{% load static %}

{% block title %}Adicionar Novo Processo{% endblock %}

{% block content %}
<style>
    /* --- Estilos do Wizard --- */
    .wizard-steps { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
    .wizard-step { text-align: center; flex: 1; position: relative; color: #adb5bd; }
    .wizard-step .step-circle { width: 40px; height: 40px; border-radius: 50%; background-color: #e9ecef; color: #adb5bd; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #e9ecef; transition: all 0.3s ease; }
    .wizard-step.active .step-circle { background-color: var(--bs-primary); color: white; border-color: var(--bs-primary); }
    .wizard-step.completed .step-circle { background-color: var(--bs-success); color: white; border-color: var(--bs-success); }
    .wizard-step p { margin-top: 0.5rem; font-size: 0.9rem; font-weight: 500; }
    .wizard-steps::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background-color: #e9ecef; z-index: -1; }
    .step-content { display: none; }
    .step-content.active { display: block; }

    /* --- Novos Estilos para a Seção de Partes --- */
    .partes-column {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .partes-list {
        flex-grow: 1;
        min-height: 150px;
        margin-bottom: 1.5rem; /* Espaço entre a lista e o seletor */
    }

    .parte-card {
        display: flex; align-items: center; gap: 0.75rem;
        background-color: white; border: 1px solid #e9ecef;
        border-left-width: 4px; border-radius: 0.375rem;
        padding: 0.75rem 1rem; margin-bottom: 0.75rem;
        transition: transform 0.2s ease;
    }
    .parte-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    }
    .parte-card.polo-ativo { border-left-color: var(--bs-success); }
    .parte-card.polo-passivo { border-left-color: var(--bs-danger); }

    .parte-card-info { flex-grow: 1; }
    .parte-card-info strong { display: block; color: #212529; }
    .parte-card-info small { color: #6c757d; }

    .empty-state-message { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: #6c757d; text-align: center; }
    .empty-state-message i { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }

    .add-parte-section {
        border-top: 1px solid #dee2e6;
        padding-top: 1.5rem;
    }
    .add-parte-section .select2-container {
        width: 100% !important;
    }

    /* --- NOVO: Estilos para a Tela de Resumo --- */
    .summary-section { margin-bottom: 1.5rem; }
    .summary-section h6 { font-weight: bold; color: var(--bs-primary); border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .summary-item { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .summary-item .label { color: #6c757d; }
    .summary-item .value { font-weight: 500; text-align: right; }
    .summary-partes ul { padding-left: 0; list-style-type: none; margin-bottom: 0; }
    .summary-partes li { background-color: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.25rem; }

</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2"><i class="bi bi-folder-plus text-primary"></i> Novo Processo</h1>
    <a href="{% url 'gestao:lista_processos' %}" class="btn btn-outline-secondary">Cancelar</a>
</div>

<div class="card shadow-sm">
    <form id="wizard-form-main" method="post" novalidate>
        {% csrf_token %}
        <div class="card-body p-4 p-md-5">
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1"><div class="step-circle">1</div><p>Partes Envolvidas</p></div>
                <div class="wizard-step" data-step="2"><div class="step-circle">2</div><p>Dados do Processo</p></div>
                <div class="wizard-step" data-step="3"><div class="step-circle">3</div><p>Gestão Interna</p></div>
                <div class="wizard-step" data-step="4"><div class="step-circle"><i class="bi bi-check-lg"></i></div><p>Revisão</p></div>
            </div>

            {% if form.errors or formset.errors %}
            <div class="alert alert-danger" role="alert">
                <strong>Por favor, corrija os erros abaixo:</strong>
                {{ form.errors }}
                {{ formset.non_form_errors }}
                {% for form_parte in formset %}{{ form_parte.errors }}{% endfor %}
            </div>
            {% endif %}

            <div id="step-1" class="step-content active">
                <div class="text-center mb-4">
                    <h4 class="mb-1">1. Partes Envolvidas</h4>
                    <p class="text-muted">Adicione os clientes que fazem parte do processo nos polos correspondentes.</p>
                </div>
                <div class="row g-4 mt-2">
                    <div class="col-lg-6">
                        <div class="partes-column">
                            <h6 class="text-success fw-bold text-center mb-3">POLO ATIVO (AUTORES)</h6>
                            <div class="partes-list" id="polo-ativo-container">
                                <div class="empty-state-message" id="empty-polo-ativo">
                                    <i class="bi bi-person-plus"></i>
                                    <span>Adicione partes a este polo</span>
                                </div>
                            </div>
                            <div class="add-parte-section">
                                <label for="polo-ativo-selector" class="form-label small fw-bold">Buscar e Adicionar Cliente ao Polo Ativo</label>
                                <select id="polo-ativo-selector" class="form-select"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                         <div class="partes-column">
                            <h6 class="text-danger fw-bold text-center mb-3">POLO PASSIVO (RÉUS)</h6>
                            <div class="partes-list" id="polo-passivo-container">
                                <div class="empty-state-message" id="empty-polo-passivo">
                                    <i class="bi bi-person-plus"></i>
                                    <span>Adicione partes a este polo</span>
                                </div>
                            </div>
                             <div class="add-parte-section">
                                <label for="polo-passivo-selector" class="form-label small fw-bold">Buscar e Adicionar Cliente ao Polo Passivo</label>
                                <select id="polo-passivo-selector" class="form-select"></select>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="d-flex justify-content-end mt-4">
                    <button id="btn-abrir-modal-cliente" class="btn btn-sm btn-outline-primary" type="button">
                        <i class="bi bi-person-plus-fill me-1"></i> Não encontrou a parte? Cadastre uma nova
                    </button>
                </div>
            </div>

            <div id="step-2" class="step-content">
                 <h4 class="mb-4 border-bottom pb-2">2. Dados Fundamentais e Trâmite</h4>
                 <div class="row g-3">
                    <div class="col-md-8">{{ form.tipo_acao.label_tag }}{{ form.tipo_acao }}</div>
                    <div class="col-md-4">{{ form.numero_processo.label_tag }}{{ form.numero_processo }}</div>
                    <div class="col-12">{{ form.descricao_caso.label_tag }}{{ form.descricao_caso }}</div>
                    <div class="col-md-6">{{ form.data_distribuicao.label_tag }}{{ form.data_distribuicao }}</div>
                    <div class="col-md-6">{{ form.valor_causa.label_tag }}{{ form.valor_causa }}</div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">{{ form.status_processo.label_tag }}{{ form.status_processo }}</div>
                    <div class="col-md-4">{{ form.fase.label_tag }}{{ form.fase }}</div>
                    <div class="col-md-4">{{ form.grau_jurisdicao.label_tag }}{{ form.grau_jurisdicao }}</div>
                    <div class="col-md-6">{{ form.tribunal.label_tag }}{{ form.tribunal }}</div>
                    <div class="col-md-6">{{ form.vara_comarca_orgao.label_tag }}{{ form.vara_comarca_orgao }}</div>
                </div>
                 <div class="col-12 pt-4 d-flex flex-wrap align-items-center gap-4">
                    <div class="form-check form-switch">{{ form.segredo_justica }} {{ form.segredo_justica.label_tag }}</div>
                    <div class="form-check form-switch">{{ form.justica_gratuita }} {{ form.justica_gratuita.label_tag }}</div>
                    <div class="form-check form-switch">{{ form.prioridade_tramitacao }} {{ form.prioridade_tramitacao.label_tag }}</div>
                </div>
            </div>

            <div id="step-3" class="step-content">
                <h4 class="mb-4 border-bottom pb-2">3. Equipe e Detalhes Internos</h4>
                <div class="row g-3">
                     <div class="col-md-6">{{ form.advogado_responsavel.label_tag }}{{ form.advogado_responsavel }}</div>
                     <div class="col-md-6">{{ form.advogados_envolvidos.label_tag }}{{ form.advogados_envolvidos }}</div>
                     <div class="col-12">{{ form.observacoes_internas.label_tag }}{{ form.observacoes_internas }}</div>
                     <div class="col-md-6">{{ form.numero_sei.label_tag }}{{ form.numero_sei }}</div>
                     <div class="col-md-6">{{ form.numero_outro_sistema.label_tag }}{{ form.numero_outro_sistema }}</div>
                     <div class="col-12 mt-4">
                        <label class="form-label d-block mb-2">{{ form.nivel_permissao.label }}</label>
                        {% for radio in form.nivel_permissao %}<div class="form-check">{{ radio.tag }} <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label></div>{% endfor %}
                    </div>
                </div>
            </div>

            <div id="step-4" class="step-content">
                <div class="text-center mb-4">
                    <h4 class="mb-1">4. Revisão e Confirmação</h4>
                    <p class="text-muted">Revise os dados informados antes de salvar o processo.</p>
                </div>
                <div class="row g-5">
                    <div class="col-lg-6">
                        <div class="summary-section">
                            <h6>Partes Envolvidas</h6>
                            <div class="summary-partes">
                                <strong>Polo Ativo:</strong>
                                <ul id="summary-polo-ativo"><li>Nenhuma parte informada.</li></ul>
                            </div>
                            <div class="summary-partes mt-3">
                                <strong>Polo Passivo:</strong>
                                <ul id="summary-polo-passivo"><li>Nenhuma parte informada.</li></ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="summary-section">
                            <h6>Dados do Processo</h6>
                            <div class="summary-item"><span class="label">Nº do Processo:</span><span class="value" id="summary-numero-processo"></span></div>
                            <div class="summary-item"><span class="label">Classe Processual:</span><span class="value" id="summary-tipo-acao"></span></div>
                             <div class="summary-item"><span class="label">Data de Distribuição:</span><span class="value" id="summary-data-distribuicao"></span></div>
                            <div class="summary-item"><span class="label">Valor da Causa:</span><span class="value" id="summary-valor-causa"></span></div>
                        </div>
                         <div class="summary-section">
                            <h6>Gestão Interna</h6>
                            <div class="summary-item"><span class="label">Advogado Responsável:</span><span class="value" id="summary-advogado-responsavel"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

        <div id="partes-form-container" style="display: none;">
            {{ formset.management_form }}
            {% for form_parte in formset.forms %}
                <div class="parte-form" data-form-index="{{ forloop.counter0 }}">
                    {{ form_parte.as_p }}
                </div>
            {% endfor %}
        </div>
        <div class="card-footer p-3 bg-light d-flex">
            <button type="button" class="btn btn-secondary" id="prev-btn" style="display: none;"><i class="bi bi-arrow-left"></i> Voltar</button>
            <div class="me-auto"></div>
            <button type="button" class="btn btn-primary" id="next-btn">Próximo <i class="bi bi-arrow-right"></i></button>
            <button type="submit" class="btn btn-success" id="save-btn" style="display: none;"><i class="bi bi-check-lg"></i> Salvar Processo</button>
        </div>
    </form>
</div>

<div id="empty-form-template" style="display: none;">{{ formset.empty_form.as_p }}</div>
<div id="parte-card-template" style="display: none;">
    <div class="parte-card">
        <i class="bi bi-person-fill text-muted"></i>
        <div class="parte-card-info">
            <strong data-name></strong>
        </div>
        <button type="button" class="btn-close remove-parte-btn" aria-label="Remover"></button>
    </div>
</div>

{% include 'gestao/partials/_modal_adicionar_cliente.html' with form=form_cliente_modal %}

{% endblock %}


{% block javascript %}
{{ block.super }}
<script>
$(function() {
    // --- LÓGICA DO WIZARD ---
    const steps = $('.wizard-step');
    const stepContents = $('.step-content');
    const nextBtn = $('#next-btn');
    const prevBtn = $('#prev-btn');
    const saveBtn = $('#save-btn');
    let currentStep = 1;
    const totalSteps = 4;

    // --- FUNÇÃO PARA PREENCHER O RESUMO ---
    function populateSummary() {
        // Dados do Processo
        $('#summary-numero-processo').text($('#id_numero_processo').val() || 'Não informado');
        $('#summary-tipo-acao').text($('#id_tipo_acao option:selected').text() || 'Não informado');

        // Formata a data para o padrão brasileiro
        const dataRaw = $('#id_data_distribuicao').val();
        if (dataRaw) {
            const [year, month, day] = dataRaw.split('-');
            $('#summary-data-distribuicao').text(`${day}/${month}/${year}`);
        } else {
            $('#summary-data-distribuicao').text('Não informado');
        }

        const valorCausa = $('#id_valor_causa').val();
        $('#summary-valor-causa').text(valorCausa ? `R$ ${parseFloat(valorCausa).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : 'Não informado');

        // Gestão Interna
        $('#summary-advogado-responsavel').text($('#id_advogado_responsavel option:selected').text() || 'Não informado');

        // Partes Envolvidas
        const poloAtivoList = $('#polo-ativo-container .parte-card');
        const poloPassivoList = $('#polo-passivo-container .parte-card');

        const populatePolo = (poloList, summaryElementId) => {
            const summaryList = $(summaryElementId);
            summaryList.empty();
            if (poloList.length > 0) {
                poloList.each(function() {
                    const nome = $(this).find('[data-name]').text();
                    summaryList.append(`<li>${nome}</li>`);
                });
            } else {
                summaryList.append(`<li class="text-muted fst-italic">Nenhuma parte informada.</li>`);
            }
        };

        populatePolo(poloAtivoList, '#summary-polo-ativo');
        populatePolo(poloPassivoList, '#summary-polo-passivo');
    }

    function updateWizard() {
        steps.each(function() {
            const step = $(this);
            const stepNum = step.data('step');
            step.toggleClass('active', stepNum === currentStep).toggleClass('completed', stepNum < currentStep);
        });
        stepContents.removeClass('active').eq(currentStep - 1).addClass('active');
        prevBtn.toggle(currentStep > 1);
        nextBtn.toggle(currentStep < totalSteps);
        saveBtn.toggle(currentStep === totalSteps);

        if (currentStep === totalSteps) {
            populateSummary();
        }

        if (currentStep === 3) {
            const advogadosSelect = $('#id_advogados_envolvidos');
            if (advogadosSelect.length && !advogadosSelect.hasClass("select2-hidden-accessible")) {
                advogadosSelect.select2({
                    theme: "bootstrap-5",
                    placeholder: 'Selecione os colaboradores',
                    width: '100%'
                });
            }
        }
    }

    // --- LÓGICA DO MODAL DE CLIENTE ---
    $('#btn-abrir-modal-cliente').on('click', function() {
        new bootstrap.Modal(document.getElementById('addClienteModal')).show();
    });

    // --- LÓGICA DAS PARTES (CLIENTES) ---
    const partesFormContainer = $('#partes-form-container');
    const totalFormsInput = $('#id_partes-TOTAL_FORMS');
    const emptyFormTemplate = $('#empty-form-template').html();
    const parteCardTemplate = $('#parte-card-template').html();
    const poloAtivoSelector = $('#polo-ativo-selector');
    const poloPassivoSelector = $('#polo-passivo-selector');
    const poloAtivoContainer = $('#polo-ativo-container');
    const poloPassivoContainer = $('#polo-passivo-container');

    const select2Options = {
        theme: "bootstrap-5",
        placeholder: 'Buscar por nome ou CPF/CNPJ...',
        allowClear: true
    };

    function carregarClientesNosSeletores(clienteSelecionadoId = null) {
        $.ajax({
            url: "{% url 'gestao:get_all_clients_json' %}",
            type: 'GET',
            success: function(clientes) {
                const data = [{id: '', text: ''}].concat(clientes);
                poloAtivoSelector.empty().select2({ data: data, ...select2Options });
                poloPassivoSelector.empty().select2({ data: data, ...select2Options });
                if (clienteSelecionadoId) {
                    poloAtivoSelector.val(clienteSelecionadoId).trigger('change');
                }
            },
            error: function() {
                alert('Erro ao carregar a lista de clientes.');
            }
        });
    }

    $(document).on('itemAdicionado', function(event) {
        if (event.detail && event.detail.tipo === 'cliente') {
            const novoClientePk = event.detail.dados.pk;
            carregarClientesNosSeletores(novoClientePk);
        }
    });

    function addParte(tipoPolo, selectedData) {
        if (!selectedData || !selectedData.id) { return; }

        const clienteId = selectedData.id;
        const clienteNome = selectedData.text;

        let formJaExiste = false;
        partesFormContainer.find('select[name$="-cliente"]').each(function() {
            const formDiv = $(this).closest('.parte-form');
            if (!formDiv.length) return;
            const isMarkedForDeletion = formDiv.find('input[name$="-DELETE"]:checked').length > 0;
            if (this.value == clienteId && !isMarkedForDeletion) {
                formJaExiste = true; return false;
            }
        });
        if (formJaExiste) {
            alert('Este cliente já foi adicionado como parte no processo.');
            // Limpa o seletor para evitar que o usuário tente adicionar de novo
            if (tipoPolo === 'AUTOR') poloAtivoSelector.val(null).trigger('change');
            else poloPassivoSelector.val(null).trigger('change');
            return;
        }

        const formIndex = parseInt(totalFormsInput.val());
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);
        const newForm = $('<div class="parte-form"></div>').attr('data-form-index', formIndex).html(newFormHtml);
        partesFormContainer.append(newForm);
        newForm.find(`select[name$="-cliente"]`).append(new Option(clienteNome, clienteId, true, true)).val(clienteId);
        newForm.find(`select[name$="-tipo_participacao"]`).val(tipoPolo);

        const newCard = $(parteCardTemplate);
        newCard.attr('data-form-index', formIndex);
        newCard.find('[data-name]').text(clienteNome);
        newCard.addClass(tipoPolo === 'AUTOR' ? 'polo-ativo' : 'polo-passivo');
        const container = (tipoPolo === 'AUTOR' ? poloAtivoContainer : poloPassivoContainer);
        container.append(newCard);
        updateEmptyState(container);
        totalFormsInput.val(formIndex + 1);
    }

    function removeParte(cardElement) {
        const card = $(cardElement);
        const container = card.parent();
        const formIndex = card.data('form-index');
        const formToRemove = partesFormContainer.find(`.parte-form[data-form-index="${formIndex}"]`);
        if (formToRemove.length) {
            const deleteCheckbox = formToRemove.find('input[type=checkbox][name$="-DELETE"]');
            if (deleteCheckbox.length) {
                deleteCheckbox.prop('checked', true);
            } else {
                // Se o formulário não foi salvo ainda, podemos removê-lo do DOM
                formToRemove.remove();
                 // Precisamos recalcular os índices se removermos um do meio,
                 // mas para esta implementação, marcar para deletar é mais seguro.
            }
        }
        card.remove();
        updateEmptyState(container);
    }

    function updateEmptyState(container) {
        const emptyMessage = container.find('.empty-state-message');
        const hasCards = container.find('.parte-card').length > 0;
        emptyMessage.toggle(!hasCards);
    }

    // --- Vinculando Eventos ---
    poloAtivoSelector.on('select2:select', function(e) { addParte('AUTOR', e.params.data); $(this).val(null).trigger('change'); });
    poloPassivoSelector.on('select2:select', function(e) { addParte('REU', e.params.data); $(this).val(null).trigger('change'); });
    nextBtn.on('click', () => { if (currentStep < totalSteps) { currentStep++; updateWizard(); } });
    prevBtn.on('click', () => { if (currentStep > 1) { currentStep--; updateWizard(); } });
    $(document).on('click', '.remove-parte-btn', function() { removeParte($(this).closest('.parte-card')); });

    // --- INICIALIZAÇÃO DA PÁGINA ---
    updateWizard();
    carregarClientesNosSeletores();
    updateEmptyState(poloAtivoContainer);
    updateEmptyState(poloPassivoContainer);
});
</script>
{% endblock %}