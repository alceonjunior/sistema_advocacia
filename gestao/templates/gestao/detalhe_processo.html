{% extends 'gestao/base.html' %}
{% load static humanize l10n %}

{% block title %}Detalhe do Processo {{ processo.numero_processo|default:"N/A" }}{% endblock %}

{% block styles %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* Estilos aprimorados para a nova estrutura de cards */
    .info-card {
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #fff;
    }
    .info-card-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        color: #495057;
    }
    .info-card-body {
        padding: 1.25rem;
    }
    .info-card-body p {
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
    }
    .info-card-body p:last-child {
        margin-bottom: 0;
    }
    .info-card-body p strong {
        display: block;
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        text-transform: uppercase;
        margin-bottom: 0.1rem;
    }
    .badge.fs-6 {
        font-size: 0.85rem !important;
        padding: 0.4em 0.7em;
    }
    .resumo-principal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }
    .select2-container .select2-selection--single { height: auto !important; padding: 0.375rem 0.75rem; }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { white-space: normal !important; line-height: 1.5; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
        <h1 class="h2 mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-folder2-open text-primary"></i> Detalhes do Processo
        </h1>
        <p class="text-muted mb-0">Nº: {{ processo.numero_processo|default:"Ainda sem número" }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'gestao:pagina_de_calculos' processo_pk=processo.pk %}" class="btn btn-outline-success"><i class="bi bi-calculator"></i> Cálculos</a>
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" id="acoesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-gear-fill"></i> Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="acoesDropdown">
                <li><a class="dropdown-item" href="{% url 'gestao:editar_processo' pk=processo.pk %}">Editar Dados Gerais</a></li>
                <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#gerenciarPartesModal">Gerenciar Partes</button></li>
                <li><hr class="dropdown-divider"></li>
                {% if processo.status_processo == 'ARQUIVADO' %}
                    <li><button type="button" class="dropdown-item text-success" data-bs-toggle="modal" data-bs-target="#desarquivarProcessoModal"><i class="bi bi-box-arrow-up me-2"></i>Desarquivar Processo</button></li>
                {% else %}
                    <li><button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#arquivarProcessoModal"><i class="bi bi-archive-fill me-2"></i>Arquivar Processo</button></li>
                {% endif %}
            </ul>
        </div>
        <a href="{% url 'gestao:lista_processos' %}" class="btn btn-secondary"><i class="bi bi-arrow-left-circle"></i> Voltar</a>
    </div>
</div>

<div class="card shadow-sm">
    <ul class="nav nav-tabs nav-fill" id="processoTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="info-gerais-tab" data-bs-toggle="tab" data-bs-target="#info-gerais-pane" type="button" role="tab" aria-controls="info-gerais-pane" aria-selected="true"><i class="bi bi-info-circle-fill me-1"></i> Informações Gerais</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="movimentacoes-tab" data-bs-toggle="tab" data-bs-target="#movimentacoes-pane" type="button" role="tab" aria-controls="movimentacoes-pane" aria-selected="false"><i class="bi bi-list-ol me-1"></i> Movimentações</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos-pane" type="button" role="tab" aria-controls="documentos-pane" aria-selected="false"><i class="bi bi-file-earmark-text me-1"></i> Documentos</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="financeiro-tab" data-bs-toggle="tab" data-bs-target="#financeiro-pane" type="button" role="tab" aria-controls="financeiro-pane" aria-selected="false"><i class="bi bi-cash-coin me-1"></i> Financeiro</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="detalhes-adicionais-tab" data-bs-toggle="tab" data-bs-target="#detalhes-adicionais-pane" type="button" role="tab" aria-controls="detalhes-adicionais-pane" aria-selected="false"><i class="bi bi-three-dots me-1"></i> Detalhes Adicionais</button></li>
    </ul>

    <div class="tab-content" id="processoTabContent">
        <div class="tab-pane fade show active" id="info-gerais-pane" role="tabpanel" aria-labelledby="info-gerais-tab" tabindex="0">
            <div class="card-body p-4">
                <div class="info-card">
                    <div class="info-card-header"><i class="bi bi-info-circle-fill text-primary"></i> Resumo Principal do Processo</div>
                    <div class="info-card-body resumo-principal-grid">
                        <div><p><strong>Nº do Processo:</strong>{{ processo.numero_processo|default:"Não informado" }}</p></div>
                        <div><p><strong>Status:</strong><span class="badge fs-6 {% if processo.status_processo == 'ARQUIVADO' %}bg-secondary-subtle text-secondary-emphasis{% elif processo.status_processo == 'ATIVO' %}bg-success-subtle text-success-emphasis{% else %}bg-primary-subtle text-primary-emphasis{% endif %}">{{ processo.get_status_processo_display }}</span></p></div>
                        <div><p><strong>Fase Atual:</strong><span class="badge fs-6 bg-info-subtle text-info-emphasis">{{ processo.get_fase_display }}</span></p></div>
                        <div><p><strong>Adv. Responsável:</strong>{% if processo.advogado_responsavel %}{{ processo.advogado_responsavel.get_full_name|default:processo.advogado_responsavel.username }}{% else %}Não definido{% endif %}</p></div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-7">
                        <div class="info-card">
                            <div class="info-card-body p-0" id="card-partes-container">
                                {% include 'gestao/partials/_card_partes_envolvidas.html' %}
                            </div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-header"><i class="bi bi-chat-left-text-fill text-primary"></i> Assunto Principal / Descrição do Caso</div>
                            <div class="info-card-body">
                                <p class="mb-0 lh-base">{{ processo.descricao_caso|linebreaksbr|default:"Nenhuma descrição fornecida." }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="info-card">
                            <div class="info-card-header"><i class="bi bi-cash-stack text-primary"></i> Resumo Financeiro</div>
                            <div class="info-card-body">
                                <p><strong>Valor da Causa:</strong>{% if processo.valor_causa %} R$ {{ processo.valor_causa|floatformat:2|localize }}{% else %} N/A {% endif %}</p>
                                <p><strong>Total Contratado:</strong> R$ {{ resumo_financeiro_processo.valor_total_contratado|floatformat:2|localize }}</p>
                                <p><strong>Total Recebido:</strong> R$ {{ resumo_financeiro_processo.total_recebido|floatformat:2|localize }}</p>
                                <p><strong>Saldo Devedor:</strong> <span class="text-danger fw-bold">R$ {{ resumo_financeiro_processo.saldo_devedor|floatformat:2|localize }}</span></p>
                            </div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-header"><i class="bi bi-building-fill text-primary"></i> Dados do Juízo</div>
                            <div class="info-card-body">
                                <p><strong>Tribunal:</strong> {{ processo.get_tribunal_display|default:"N/A" }}</p>
                                <p><strong>Grau de Jurisdição:</strong> {{ processo.get_grau_jurisdicao_display|default:"N/A" }}</p>
                                <p><strong>Órgão Julgador:</strong> {{ processo.vara_comarca_orgao|default:"N/A" }}</p>
                                <p class="mb-0"><strong>Distribuído em:</strong> {{ processo.data_distribuicao|date:"d/m/Y" }}</p>
                            </div>
                        </div>
                         <div class="info-card">
                             <div class="info-card-header"><i class="bi bi-person-workspace text-primary"></i> Equipe Interna</div>
                             <div class="info-card-body">
                                {% if processo.advogados_envolvidos.all %}
                                <p class="mb-0"><strong>Outros Colaboradores:</strong>
                                    {% for advogado in processo.advogados_envolvidos.all %}{{ advogado.get_full_name|default:advogado.username }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </p>
                                {% else %}
                                <p class="mb-0 text-muted">Nenhum outro colaborador envolvido.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="movimentacoes-pane" role="tabpanel" aria-labelledby="movimentacoes-tab" tabindex="0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0"><i class="bi bi-list-ol me-2 text-primary"></i> Histórico de Movimentações</h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#adicionarMovimentacaoModal"><i class="bi bi-plus-circle-fill me-1"></i> Adicionar Movimentação</button>
            </div>
            <div class="card-body p-3">
                {% with processo.movimentacoes.all as movimentacoes %}{% include 'gestao/partials/_historico_movimentacoes.html' %}{% endwith %}
            </div>
        </div>

        <div class="tab-pane fade" id="documentos-pane" role="tabpanel" aria-labelledby="documentos-tab" tabindex="0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2 text-primary"></i> Documentos do Processo</h5>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-plus-circle me-1"></i> Gerar Documento
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% for modelo in todos_modelos %}
                            <li><a class="dropdown-item" href="{% url 'gestao:gerar_documento' processo_pk=processo.pk modelo_pk=modelo.pk %}">{{ modelo.titulo }}</a></li>
                        {% empty %}
                            <li><a class="dropdown-item disabled" href="#">Nenhum modelo cadastrado</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead><tr><th>Título</th><th>Tipo</th><th>Data de Criação</th><th class="text-end">Ações</th></tr></thead>
                    <tbody>
                    {% for doc in processo.documentos.all %}
                        <tr>
                            <td>{{ doc.titulo }}</td>
                            <td>{{ doc.get_tipo_documento_display }}</td>
                            <td>{{ doc.data_criacao|date:"d/m/Y H:i" }}</td>
                            <td class="text-end">
                                <a href="{% url 'gestao:editar_documento' pk=doc.pk %}" class="btn btn-sm btn-outline-secondary">Editar</a>
                                <a href="{% url 'gestao:imprimir_documento' pk=doc.pk %}" class="btn btn-sm btn-outline-primary" target="_blank">Imprimir</a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" class="text-center text-muted p-4">Nenhum documento cadastrado para este processo.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="financeiro-pane" role="tabpanel" aria-labelledby="financeiro-tab" tabindex="0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0"><i class="bi bi-cash-coin me-2 text-primary"></i> Financeiro Detalhado</h5>
                <a href="{% url 'gestao:adicionar_contrato_processo' processo_pk=processo.pk %}" class="btn btn-sm btn-success"><i class="bi bi-plus-circle me-1"></i> Adicionar Contrato</a>
            </div>
            <div class="card-body p-0" id="financial-table-container" data-parent-pk="{{ processo.pk }}" data-parent-type="processo">
                </div>
        </div>

        <div class="tab-pane fade" id="detalhes-adicionais-pane" role="tabpanel" aria-labelledby="detalhes-adicionais-tab" tabindex="0">
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-lg-6">
                        {% include 'gestao/partials/_detalhe_recursos.html' %}
                    </div>
                    <div class="col-lg-6">
                        {% include 'gestao/partials/_detalhe_incidentes.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Inclusão de todos os modais necessários para a página #}
{% include 'gestao/partials/_modal_movimentacao.html' %}
{% include 'gestao/partials/_modal_editar_movimentacao.html' %}
{% include 'gestao/partials/_modal_gerenciar_partes.html' %}
{% include 'gestao/partials/_modal_pagamento.html' %}
{% include 'gestao/partials/_modal_arquivamento.html' with processo=processo %}

{% endblock %}


{% block javascript %}
{{ block.super }}

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializa Select2 para o modal de adição de movimentação
    $('#adicionarMovimentacaoModal .select2').select2({
        theme: 'bootstrap-5',
        dropdownParent: $('#adicionarMovimentacaoModal')
    });

    // Lógica para ativar a aba correta via hash na URL
    const url = new URL(window.location.href);
    if (url.hash) {
        const tabTrigger = document.querySelector(`.nav-tabs button[data-bs-target="${url.hash}"]`);
        if (tabTrigger) {
            new bootstrap.Tab(tabTrigger).show();
        }
    }
});
</script>

{# Inclusão dos scripts modulares para cada funcionalidade da página #}
{% include 'gestao/partials/_detalhe_gerenciar_partes_js.html' %}
{% include 'gestao/partials/_detalhe_financeiro_js.html' %}
{% include 'gestao/partials/_detalhe_movimentacao_modal_js.html' %}
{% include 'gestao/partials/_prazo_calculator_js.html' %}

{% endblock %}