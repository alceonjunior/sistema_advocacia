{% comment %}
Arquivo: gestao/partials/_lista_clientes_partial.html
Este template renderiza a grade de cards de clientes e é projetado para
ser incluído na página principal ou carregado via AJAX.
{% endcomment %}

{% for cliente in filter.qs %}
<div class="col-md-6 col-lg-4 mb-4">
    <div class="card h-100 shadow-sm client-card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3" style="min-width: 0;">
                <div class="avatar-circle flex-shrink-0 {% if cliente.tipo_pessoa == 'PF' %}bg-primary-subtle text-primary{% else %}bg-secondary-subtle text-secondary{% endif %}">
                    <i class="bi {% if cliente.tipo_pessoa == 'PF' %}bi-person-fill{% else %}bi-building-fill{% endif %} fs-5"></i>
                </div>
                <h5 class="card-title mb-0 fs-6 fw-bold text-truncate" title="{{ cliente.nome_completo }}">{{ cliente.nome_completo }}</h5>
            </div>
            <div class="d-flex align-items-center flex-shrink-0">
                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2 btn-editar" data-pk="{{ cliente.pk }}" title="Editar Cliente">
                    <i class="bi bi-pencil-fill"></i>
                </button>

                {# ===== INÍCIO DA LÓGICA CORRIGIDA ===== #}
                {% if cliente.processos_ativos_count > 0 or cliente.servicos_ativos_count > 0 %}
                    <span class="d-inline-block ms-1" tabindex="0" data-bs-toggle="tooltip"
                          title="Não pode ser excluído. Vínculos ativos:
{% if cliente.processos_ativos_count > 0 %}- {{ cliente.processos_ativos_count }} Processo(s)
{% endif %}{% if cliente.servicos_ativos_count > 0 %}- {{ cliente.servicos_ativos_count }} Serviço(s){% endif %}">
                        <button class="btn btn-sm btn-outline-danger py-0 px-2" type="button" disabled style="pointer-events: none;">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </span>
                {% else %}
                    <button class="btn btn-sm btn-outline-danger py-0 px-2 ms-1" type="button"
                            data-bs-toggle="modal" data-bs-target="#deleteClienteModal"
                            data-delete-url="{% url 'excluir_cliente' pk=cliente.pk %}"
                            data-nome="{{ cliente.nome_completo }}">
                        <i class="bi bi-trash-fill"></i>
                    </button>

                {% endif %}

                {# ===== FIM DA LÓGICA CORRIGIDA ===== #}
            </div>
        </div>
        <div class="card-body small">
            <p class="card-text text-muted mb-2"><i class="bi bi-person-badge me-2"></i>{{ cliente.cpf_cnpj|default:"Não informado" }}</p>
            <p class="card-text text-muted mb-2"><i class="bi bi-envelope-at me-2"></i>{{ cliente.email|default:"Não informado" }}</p>
            <p class="card-text text-muted mb-0"><i class="bi bi-telephone me-2"></i>{{ cliente.telefone_principal|default:"Não informado" }}</p>
        </div>
        <div class="card-footer bg-light-subtle d-flex justify-content-around small text-center">
            <div>
                <div class="fw-bold fs-5">{{ cliente.processos_ativos_count|default:0 }}</div>
                <div class="text-muted">Processos Ativos</div>
            </div>
            <div>
                <div class="fw-bold fs-5">{{ cliente.servicos_ativos_count|default:0 }}</div>
                <div class="text-muted">Serviços Ativos</div>
            </div>
        </div>
    </div>
</div>
{% empty %}
<div class="col-12">
    <div class="text-center p-5 border rounded-3 bg-light">
        <i class="bi bi-people fs-1 text-muted"></i>
        <h5 class="mt-2">Nenhum cliente encontrado</h5>
        <p class="text-muted">Tente ajustar os filtros ou adicione um novo cliente.</p>
    </div>
</div>
{% endfor %}