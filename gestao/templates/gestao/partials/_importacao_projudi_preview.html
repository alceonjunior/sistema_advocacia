{% comment %}
Este template renderiza a revisão com um layout aprimorado:
- Lista de itens com rolagem interna para não estender a página.
- Rodapé de ações sempre visível.
{% endcomment %}

<style>
    /* Estilo para a área de rolagem interna */
    .import-list-scrollable {
        max-height: 50vh; /* Altura máxima de 50% da altura da tela */
        overflow-y: auto;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    .card-desativado { opacity: 0.6; background-color: #f8f9fa; }
</style>

<form id="form-import" method="POST" action="{% url 'gestao:confirmar_importacao_projudi' %}">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <input type="hidden" name="import_type" value="{{ import_type }}">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Passo 2 de 3: Revise os Dados a Serem Importados</h5>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="selecionar-todos-switch" checked>
            <label class="form-check-label" for="selecionar-todos-switch"><strong>Importar Todos</strong></label>
        </div>
    </div>

    <div class="import-list-scrollable bg-light">
        {% for analise in dados_analisados %}
        <div class="card mb-3 preview-card">
            <div class="card-header bg-white p-3">
                <div class="row align-items-start">
                    <div class="col-auto pt-2">
                        <input class="form-check-input import-checkbox" type="checkbox" value="{{ forloop.counter0 }}" name="importar_indice" checked>
                    </div>
                    <div class="col p-2">
                        <strong>Processo:</strong> {{ analise.processo.numero }}
                        {% if analise.processo.existe %}<span class="badge bg-info-subtle text-info-emphasis">Existente</span>{% else %}<span class="badge bg-success-subtle text-success-emphasis">Novo</span>{% endif %}
                        <input type="hidden" name="processo_{{ forloop.counter0 }}_numero" value="{{ analise.processo.numero }}">
                    </div>
                </div>
            </div>

            <div class="card-body p-3">
                <div class="row g-3">
                    <div class="col-md-7 border-end-md">
                        <h6><i class="bi bi-people-fill me-1"></i> Partes Envolvidas</h6>
                        <p class="small text-muted mb-2">Confirme os nomes, polos e marque quais partes são seus clientes.</p>
                        {% for parte in analise.partes %}
                        <div class="border rounded p-3 mb-2">
                            <div class="row g-3 align-items-end">
                                <div class="col-12"><label class="form-label small text-muted">Nome Original:</label><p class="form-text mt-0 text-truncate" title="{{ parte.nome_original|default:parte.nome_sugerido }}">"{{ parte.nome_original|default:parte.nome_sugerido }}"</p></div>
                                <div class="col-md-5"><label class="form-label fw-bold small">Nome a ser Salvo</label><input type="text" class="form-control form-control-sm" name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_nome" value="{{ parte.nome_sugerido }}"></div>
                                <div class="col-md-4"><label class="form-label fw-bold small">Polo Processual</label><select class="form-select form-select-sm" name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_polo"><option value="AUTOR" {% if parte.polo == 'AUTOR' %}selected{% endif %}>Polo Ativo</option><option value="REU" {% if parte.polo == 'REU' %}selected{% endif %}>Polo Passivo</option><option value="TERCEIRO" {% if parte.polo == 'TERCEIRO' %}selected{% endif %}>Terceiro</option><option value="VITIMA" {% if parte.polo == 'VITIMA' %}selected{% endif %}>Vítima</option></select></div>
                                <div class="col-md-3">
                                    <div class="form-check"><input class="form-check-input" type="checkbox" name="processo_{{ forloop.parentloop.counter0 }}_cliente_principal" id="cliente_principal_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" value="{{ forloop.counter0 }}" {% if import_type == 'movimentacoes' %}checked{% endif %}><label class="form-check-label fw-bold small" for="cliente_principal_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">Cliente?</label></div>
                                </div>
                                <div class="col-12 mt-3">
                                    <div class="form-check"><input class="form-check-input vincular-parte-checkbox" type="checkbox" id="vincular_parte_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" {% if parte.cliente_id %}checked{% endif %}><label class="form-check-label small" for="vincular_parte_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">Vincular a um cadastro existente</label></div>
                                    <select name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_id_vincular" class="form-select form-select-sm select2-cliente" style="display:{% if parte.cliente_id %}block{% else %}none{% endif %};"><option value="">Selecione um cliente...</option>{% for c in todos_clientes %}<option value="{{ c.pk }}" {% if c.pk == parte.cliente_id %}selected{% endif %}>{{ c.nome_completo }}</option>{% endfor %}</select>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-5">
                        {% if import_type == 'movimentacoes' %}
                            <h6><i class="bi bi-hourglass-split me-1"></i> Detalhes do Prazo</h6>
                            <div class="alert alert-secondary p-2 small"><strong>Postagem:</strong> {{ analise.movimentacao.dtPostagem }}<br><strong>Intimação:</strong> {{ analise.movimentacao.dataIntimacao }}<br><strong>Prazo Final (Projudi):</strong> {{ analise.movimentacao.prazo }}</div>
                            <input type="hidden" name="movimentacao_{{ forloop.counter0 }}_intimacao" value="{{ analise.movimentacao.dataIntimacao }}"><input type="hidden" name="movimentacao_{{ forloop.counter0 }}_prazo" value="{{ analise.movimentacao.prazo }}">
                        {% elif import_type == 'audiencias' %}
                            <h6><i class="bi bi-calendar-event-fill me-1"></i> Detalhes da Audiência</h6>
                            <div class="alert alert-secondary p-2 small"><strong>Data:</strong> {{ analise.audiencia.data }}<br><strong>Hora:</strong> {{ analise.audiencia.hora }}<br><strong>Local:</strong> {{ analise.audiencia.localAudiencia }}<br><strong>Tipo:</strong> {{ analise.audiencia.tipoAudiencia }}</div>
                            <input type="hidden" name="audiencia_{{ forloop.counter0 }}_data" value="{{ analise.audiencia.data }}"><input type="hidden" name="audiencia_{{ forloop.counter0 }}_hora" value="{{ analise.audiencia.hora }}"><input type="hidden" name="audiencia_{{ forloop.counter0 }}_detalhes" value="Local: {{ analise.audiencia.localAudiencia }} | Modalidade: {{ analise.audiencia.modalidade }}">
                        {% endif %}
                        <div class="mb-2">
                            <label class="form-label fw-bold">Categorizar Movimentação como:</label>
                            <select name="processo_{{ forloop.counter0 }}_tipo_movimentacao" class="form-select" required><option value="">Selecione um tipo...</option>{% for tipo in todos_tipos_movimentacao %}<option value="{{ tipo.pk }}">{{ tipo.nome }}</option>{% endfor %}</select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button type="button" id="btn-limpar-importacao" class="btn btn-outline-danger">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Limpar e Recomeçar
        </button>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-arrow-right-circle-fill me-1"></i> Próximo: Confirmar Resumo
        </button>
    </div>
</form>