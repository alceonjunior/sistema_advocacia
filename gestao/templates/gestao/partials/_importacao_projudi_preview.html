{% load l10n %}
<form id="form-import" method="post" action="{% url 'gestao:processar_importacao_projudi' %}">
    {% csrf_token %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="selecionar-todos-switch" checked>
            <label class="form-check-label" for="selecionar-todos-switch"><strong>Selecionar/Deselecionar Todos</strong></label>
        </div>
    </div>

    {% for analise in dados_analisados %}
    <div class="card shadow-sm mb-3 preview-card {% if analise.processo.existe %}status-exists{% else %}status-new{% endif %}">
        <div class="card-body p-3">
            <div class="d-flex align-items-start">
                <div class="form-check me-3 mt-1">
                    <input class="form-check-input import-checkbox" type="checkbox" value="{{ forloop.counter0 }}" name="importar_indice" checked>
                </div>

                <div class="flex-grow-1">
                    <h5 class="card-title d-flex justify-content-between">
                        <span>Processo {{ analise.processo.numero }}</span>
                        {% if analise.processo.existe %}<span class="badge bg-info">Vincular</span>{% else %}<span class="badge bg-success">Novo</span>{% endif %}
                    </h5>
                    <input type="hidden" name="processo_{{ forloop.counter0 }}_numero" value="{{ analise.processo.numero }}">
                    <hr>

                    <h6><i class="bi bi-calendar-event me-2"></i>Audiência a ser Agendada</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-7">
                            <p class="mb-1"><strong class="text-muted">Tipo Projudi:</strong> {{ analise.audiencia.tipo }}</p>
                            <p class="mb-0"><strong class="text-muted">Data:</strong> {{ analise.audiencia.data }} às {{ analise.audiencia.hora }}</p>
                        </div>
                        <div class="col-md-5">
                             <label class="form-label fw-bold small">Categorizar como:</label>
                             <select name="audiencia_{{ forloop.counter0 }}_tipo_movimentacao" class="form-select form-select-sm">
                                {% for tipo in tipos_movimentacao_audiencia %}<option value="{{ tipo.pk }}" {% if tipo.pk == analise.audiencia.sugestao_tipo_id %}selected{% endif %}>{{ tipo.nome }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <input type="hidden" name="audiencia_{{ forloop.counter0 }}_titulo" value="{{ analise.audiencia.tipo }}">
                    <input type="hidden" name="audiencia_{{ forloop.counter0 }}_data" value="{{ analise.audiencia.data }}">
                    <input type="hidden" name="audiencia_{{ forloop.counter0 }}_hora" value="{{ analise.audiencia.hora }}">
                    {% with detalhes="Situação: "|add:analise.audiencia.situacao|add:"\nModalidade: "|add:analise.audiencia.modalidade|add:"\nLocal: "|add:analise.audiencia.local %}
                        <input type="hidden" name="audiencia_{{ forloop.counter0 }}_detalhes" value="{{ detalhes }}">
                    {% endwith %}

                    <h6><i class="bi bi-people-fill me-2"></i>Partes Envolvidas</h6>
                    {% for parte in analise.partes %}
                    <div class="p-3 rounded mb-2 {% if parte.status == 'EXISTENTE' %}bg-info-subtle{% elif parte.status == 'NOVO' %}bg-success-subtle{% else %}bg-warning-subtle{% endif %}">
                        <div class="row align-items-center">
                            <div class="col-md-5"><strong>{{ parte.polo }}:</strong><br>{{ parte.nome_original }}</div>
                            <div class="col-md-3 text-center">
                                {% if parte.status == 'EXISTENTE' %} <span class="badge bg-info">Cliente Encontrado</span>
                                {% elif parte.status == 'NOVO' %} <span class="badge bg-success">Novo Cliente</span>
                                {% else %} <span class="badge bg-warning text-dark">Duplicado</span>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <select name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_acao" class="form-select form-select-sm select-acao-parte">
                                    {% if parte.status == 'EXISTENTE' %}<option value="vincular" selected>Vincular ao existente</option><option value="criar_novo">Criar como um novo cliente</option>
                                    {% elif parte.status == 'NOVO' %}<option value="criar_novo" selected>Criar como um novo cliente</option>
                                    {% else %}<option value="ignorar" selected>Ignorar (duplicado)</option>{% endif %}
                                    <option value="vincular_manual">Vincular a outro cliente...</option>
                                    <option value="ignorar">Não importar esta parte</option>
                                </select>
                                <input type="hidden" name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_cliente_id" value="{{ parte.cliente_id|default:'' }}">
                                <input type="hidden" name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_nome" value="{{ parte.nome_original }}">
                                <input type="hidden" name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_polo" value="{{ parte.polo }}">
                            </div>
                        </div>
                        <div class="vincular-manual-container mt-2" style="display:none;">
                            <select name="processo_{{ forloop.parentloop.counter0 }}_parte_{{ forloop.counter0 }}_cliente_id_manual" class="form-select form-select-sm select2-vincular">
                                <option value="">Selecione um cliente para vincular...</option>
                                {% for cliente in todos_clientes %}<option value="{{ cliente.pk }}">{{ cliente.nome_completo }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
        <div class="alert alert-warning">Nenhuma audiência encontrada nos dados do JSON.</div>
    {% endfor %}
    <div class="text-end mt-4"><button type="submit" class="btn btn-success btn-lg"><i class="bi bi-check-all me-1"></i> Importar Selecionados</button></div>
</form>