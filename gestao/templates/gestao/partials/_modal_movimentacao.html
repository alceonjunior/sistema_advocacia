<div class="modal fade" id="adicionarMovimentacaoModal" tabindex="-1" aria-labelledby="adicionarMovimentacaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="">
                {% csrf_token %}
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="adicionarMovimentacaoModalLabel">Adicionar Nova Movimentação</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form_movimentacao.tipo_movimentacao.id_for_label }}" class="form-label fw-bold">{{ form_movimentacao.tipo_movimentacao.label }}</label>
                            {{ form_movimentacao.tipo_movimentacao }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form_movimentacao.titulo.id_for_label }}" class="form-label">{{ form_movimentacao.titulo.label }}</label>
                            {{ form_movimentacao.titulo }}
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-primary">Cálculo de Prazo</h6>
                    
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <label for="{{ form_movimentacao.data_publicacao.id_for_label }}" class="form-label">{{ form_movimentacao.data_publicacao.label }}</label>
                            {{ form_movimentacao.data_publicacao }}
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <label for="{{ form_movimentacao.data_intimacao.id_for_label }}" class="form-label">{{ form_movimentacao.data_intimacao.label }}</label>
                            {{ form_movimentacao.data_intimacao }}
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <label for="{{ form_movimentacao.data_inicio_prazo.id_for_label }}" class="form-label">{{ form_movimentacao.data_inicio_prazo.label }}</label>
                            {{ form_movimentacao.data_inicio_prazo }}
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <label for="{{ form_movimentacao.data_prazo_final.id_for_label }}" class="form-label fw-bold">Data do Prazo Final</label>
                            {{ form_movimentacao.data_prazo_final }}
                        </div>
                    </div>

                    <hr>
                    
                    <div class="mb-3">
                        <label for="{{ form_movimentacao.detalhes.id_for_label }}" class="form-label">{{ form_movimentacao.detalhes.label }}</label>
                        {{ form_movimentacao.detalhes }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form_movimentacao.link_referencia.id_for_label }}" class="form-label">{{ form_movimentacao.link_referencia.label }}</label>
                        {{ form_movimentacao.link_referencia }}
                        {% if form_movimentacao.link_referencia.help_text %}
                            <small class="form-text text-muted">{{ form_movimentacao.link_referencia.help_text }}</small>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form_movimentacao.responsavel.id_for_label }}" class="form-label">{{ form_movimentacao.responsavel.label }}</label>
                            {{ form_movimentacao.responsavel }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form_movimentacao.status.id_for_label }}" class="form-label">{{ form_movimentacao.status.label }}</label>
                            {{ form_movimentacao.status }}
                        </div>
                    </div>
                     <div class="col-md-6 mb-3 d-none" id="div_id_hora_prazo">
                        <label for="{{ form_movimentacao.hora_prazo.id_for_label }}" class="form-label">{{ form_movimentacao.hora_prazo.label }}</label>
                        {{ form_movimentacao.hora_prazo }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" name="submit_movimentacao" class="btn btn-primary">Salvar Movimentação</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('adicionarMovimentacaoModal');
    if (!modal) return;
    
    // Converte o JSON de prazos do Django para um objeto JavaScript
    const prazosSugeridos = JSON.parse('{{ prazos_sugeridos_json|escapejs }}' || '{}');

    modal.addEventListener('shown.bs.modal', function () {
        const dataPublicacaoEl = document.getElementById('{{ form_movimentacao.data_publicacao.id_for_label }}');
        const dataIntimacaoEl = document.getElementById('{{ form_movimentacao.data_intimacao.id_for_label }}');
        const dataInicioPrazoEl = document.getElementById('{{ form_movimentacao.data_inicio_prazo.id_for_label }}');
        const dataPrazoFinalEl = document.getElementById('{{ form_movimentacao.data_prazo_final.id_for_label }}');
        const tipoMovimentacaoEl = document.getElementById('{{ form_movimentacao.tipo_movimentacao.id_for_label }}');

        // --- Funções Auxiliares para Cálculo de Datas ---
        const toDate = (dateString) => new Date(dateString + 'T12:00:00');

        const formatDate = (date) => {
            if (!date || isNaN(date)) return '';
            return date.toISOString().split('T')[0];
        };

        const addBusinessDays = (startDate, days) => {
            let currentDate = new Date(startDate.valueOf());
            let addedDays = 0;
            while (addedDays < days) {
                currentDate.setDate(currentDate.getDate() + 1);
                const dayOfWeek = currentDate.getDay(); // 0 = Domingo, 6 = Sábado
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    addedDays++;
                }
            }
            return currentDate;
        };

        const getNextBusinessDay = (startDate) => {
            let nextDay = new Date(startDate.valueOf());
            nextDay.setDate(nextDay.getDate() + 1);
            let dayOfWeek = nextDay.getDay();
            if (dayOfWeek === 6) { // Sábado
                nextDay.setDate(nextDay.getDate() + 2);
            } else if (dayOfWeek === 0) { // Domingo
                nextDay.setDate(nextDay.getDate() + 1);
            }
            return nextDay;
        };

        // --- Lógica Principal de Cálculo ---
        function calcularTudo() {
            // 1. Sugere Data da Intimação a partir da Publicação
            if (dataPublicacaoEl.value && !dataIntimacaoEl.value) {
                dataIntimacaoEl.value = dataPublicacaoEl.value;
            }

            // 2. Sugere Primeiro Dia do Prazo a partir da Intimação
            if (dataIntimacaoEl.value) {
                const intimacaoDate = toDate(dataIntimacaoEl.value);
                const proximoDiaUtil = getNextBusinessDay(intimacaoDate);
                dataInicioPrazoEl.value = formatDate(proximoDiaUtil);
            } else {
                dataInicioPrazoEl.value = '';
            }
            
            // 3. Calcula o Prazo Final a partir do Início do Prazo e do Tipo de Movimentação
            const tipoId = tipoMovimentacaoEl.value;
            const diasSugeridos = prazosSugeridos[tipoId];
            if (dataInicioPrazoEl.value && diasSugeridos) {
                const inicioPrazoDate = toDate(dataInicioPrazoEl.value);
                // Subtrai 1 dia, pois o primeiro dia do prazo já conta.
                const prazoFinalDate = addBusinessDays(inicioPrazoDate, diasSugeridos - 1);
                dataPrazoFinalEl.value = formatDate(prazoFinalDate);
            }
        }
        
        // --- Event Listeners ---
        dataPublicacaoEl.addEventListener('change', () => {
            dataIntimacaoEl.value = dataPublicacaoEl.value; // Sugere
            calcularTudo();
        });
        dataIntimacaoEl.addEventListener('change', calcularTudo);
        tipoMovimentacaoEl.addEventListener('change', calcularTudo);
    });
});
</script>