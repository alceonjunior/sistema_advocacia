{% load humanize %}

{% for processo in filter.qs %}
<div class="col">
    <div class="card h-100 shadow-sm processo-card border-start-0">
        <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0">
            <h5 class="card-title mb-1">
                <a href="{{ processo.get_absolute_url }}" class="text-decoration-none stretched-link">
                    {{ processo.descricao_caso|truncatechars:60|default:"Processo sem descrição" }}
                </a>
            </h5>
            <small class="text-muted">Proc. nº {{ processo.numero_processo|default:"N/A" }}</small>
        </div>

        <div class="card-body d-flex flex-column pt-2">
            <div class="mb-3">
                {% for parte in processo.partes.all %}
                    {% if parte.tipo_participacao == 'AUTOR' %}
                        <div class="d-flex align-items-center gap-2 text-success small mb-1" title="Polo Ativo">
                            <i class="bi bi-arrow-up-right-circle-fill"></i>
                            <span>
                                {% if parte.is_cliente_do_processo %}
                                    <i class="bi bi-star-fill text-warning me-1" title="Cliente representado pelo escritório"></i>
                                {% endif %}
                                {{ parte.cliente.nome_completo|truncatechars:35 }}
                            </span>
                        </div>
                    {% endif %}
                {% endfor %}

                {% for parte in processo.partes.all %}
                    {% if parte.tipo_participacao == 'REU' %}
                        <div class="d-flex align-items-center gap-2 text-danger small" title="Polo Passivo">
                            <i class="bi bi-arrow-down-left-circle-fill"></i>
                            <span>
                                {% if parte.is_cliente_do_processo %}
                                    <i class="bi bi-star-fill text-warning me-1" title="Cliente representado pelo escritório"></i>
                                {% endif %}
                                {{ parte.cliente.nome_completo|truncatechars:35 }}
                            </span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="mb-3 small text-muted">
                <div class="d-flex align-items-center gap-2" title="Órgão Julgador">
                    <i class="bi bi-building-fill-gear"></i>
                    <span>{{ processo.vara_comarca_orgao|default:"Vara/Comarca não informada" }}</span>
                </div>
            </div>

            <div class="mt-auto">
                <div class="d-flex flex-wrap gap-2 justify-content-start align-items-center mb-3">
                    <span class="badge d-flex align-items-center
                        {% if processo.status_processo == 'ATIVO' %} bg-success-subtle text-success-emphasis
                        {% elif processo.status_processo == 'SUSPENSO' %} bg-warning-subtle text-warning-emphasis
                        {% elif processo.status_processo == 'ARQUIVADO' %} bg-secondary-subtle text-secondary-emphasis
                        {% else %} bg-light-subtle text-light-emphasis {% endif %}
                        rounded-pill px-2 py-1 small">
                        <i class="bi bi-gavel me-1"></i> {{ processo.get_status_processo_display }}
                    </span>
                    <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill px-2 py-1 small d-flex align-items-center">
                        <i class="bi bi-tag-fill me-1"></i> {{ processo.get_fase_display }}
                    </span>

                    <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1 small d-flex align-items-center" title="Valor da Causa">
                        <i class="bi bi-currency-dollar me-1"></i>
                        R$ {{ processo.valor_causa|default:"0,00"|intcomma }}
                    </span>
                </div>

                {% if processo.proximo_prazo %}
                    {% now "Y-m-d" as today_iso %}
                    {% with dias_restantes=processo.proximo_prazo|timeuntil:today %}
                    <div class="p-2 rounded mt-2 small
                        {% if processo.proximo_prazo|date:"Y-m-d" < today_iso %} border border-danger bg-danger-subtle text-danger-emphasis
                        {% elif processo.proximo_prazo|date:"Y-m-d" == today_iso %} border border-warning bg-warning-subtle text-warning-emphasis
                        {% else %} border border-primary-subtle bg-primary-emphasis {% endif %}
                    ">
                        <i class="bi bi-calendar2-event-fill me-1"></i>
                        <strong>Próximo Prazo:</strong> {{ processo.proximo_prazo|date:"d/m/Y" }}

                        <span class="fw-bold">
                            {% if processo.proximo_prazo|date:"Y-m-d" < today_iso %}
                               (Vencido)
                            {% elif processo.proximo_prazo|date:"Y-m-d" == today_iso %}
                               (Vence Hoje!)
                            {% else %}
                               (em {{ dias_restantes }})
                            {% endif %}
                        </span>
                    </div>
                    {% endwith %}
                {% endif %}

                <div class="border-top pt-2 mt-3 text-end small text-muted">
                    <i class="bi bi-person-fill"></i> Resp: {{ processo.advogado_responsavel.get_full_name|default:processo.advogado_responsavel.username }}
                </div>
            </div>
        </div>
    </div>
</div>
{% empty %}
<div class="col-12 text-center py-5">
    <h5 class="text-muted">Nenhum processo encontrado.</h5>
    <p class="text-muted">Tente ajustar os filtros ou adicione um novo processo.</p>
</div>
{% endfor %}