{% load l10n %}

{% with cliente=servico.cliente lancamento=servico.lancamentos.first %}
<div class="modal fade" id="nfseModal" tabindex="-1" aria-labelledby="nfseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'gestao:emitir_nfse' servico.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-header border-0">
                    <h5 class="modal-title d-flex align-items-center gap-2" id="nfseModalLabel">
                        <i class="bi bi-receipt-cutoff text-primary"></i>
                        Confirmar Emissão de NFS-e (Modo de Teste)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body pt-0">
                    <p class="text-muted">Por favor, confirme os dados abaixo antes de enviar o RPS para emissão.</p>

                    <h6 class="text-uppercase small fw-bold text-muted"><i class="bi bi-building me-2"></i>Emissor (Seus Dados)</h6>
                    <div class="p-3 mb-3 bg-light rounded-3">
                        <p class="mb-1"><strong>Razão Social:</strong> {{ escritorio_config.nome_escritorio }}</p>
                        <p class="mb-1"><strong>CNPJ:</strong> {{ escritorio_config.cnpj }}</p>
                        <p class="mb-0"><strong>Inscrição Municipal:</strong> {{ escritorio_config.inscricao_municipal|default:"Não informada" }}</p>
                    </div>

                    <h6 class="text-uppercase small fw-bold text-muted"><i class="bi bi-person me-2"></i>Destinatário (Cliente)</h6>
                    <div class="p-3 mb-3 bg-light rounded-3">
                        <p class="mb-1"><strong>Nome:</strong> {{ cliente.nome_completo }}</p>
                        <p class="mb-1"><strong>CPF/CNPJ:</strong> {{ cliente.cpf_cnpj }}</p>
                        <p class="mb-0"><strong>Endereço:</strong> {{ cliente.logradouro|default:"" }}, {{ cliente.numero|default:"S/N" }} - {{ cliente.cidade|default:"" }}/{{ cliente.estado|default:"" }}</p>
                    </div>

                    <hr class="my-4">

                    <h6 class="text-uppercase small fw-bold text-muted"><i class="bi bi-file-text me-2"></i>Dados do Serviço e Valor</h6>
                    <div class="p-3 border rounded-3">
                        <div class="mb-3">
                            <label class="form-label small">Descrição do Serviço:</label>
                            <p class="form-text mt-0">{{ servico.tipo_servico.nome }}</p>
                        </div>
                        <div class="mb-3">
                            <label for="id_codigo_servico_municipal" class="form-label small">Código do Serviço (LC 116/03):</label>
                            <input type="text" class="form-control form-control-sm" name="codigo_servico_municipal" value="{{ servico.codigo_servico_municipal|default:'' }}" id="id_codigo_servico_municipal" placeholder="Ex: 01.07">
                        </div>
                        <div class="mt-3 p-3 bg-primary-subtle rounded-3 text-center">
                            <span class="text-primary-emphasis small">VALOR TOTAL DO SERVIÇO</span>
                            <h3 class="mb-0 text-primary-emphasis">R$ {{ lancamento.valor|floatformat:2|localize }}</h3>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Atenção:</strong> Esta é uma simulação em <strong>ambiente de teste</strong>. Nenhuma nota fiscal com valor fiscal será gerada.
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-send-check me-1"></i> Confirmar e Enviar RPS</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endwith %}