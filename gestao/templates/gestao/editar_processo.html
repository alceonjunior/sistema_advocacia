{% extends 'gestao/base.html' %}

{% block title %}Editar Processo - {{ processo.numero_processo|default:"Sem Número" }}{% endblock %}

{% block styles %}
{{ block.super }}
<style>
    /* Estilos para o novo componente de lista dupla (Dual Listbox) */
    .dual-listbox-container {
        display: flex;
        align-items: stretch;
    }
    .dual-listbox-col {
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    .dual-listbox-controls {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 1.5rem;
    }
    .dual-listbox-controls .btn {
        margin-bottom: 0.5rem;
    }
    .dual-listbox-list {
        height: 300px;
        border-radius: 0.375rem;
    }
    .dual-listbox-list option {
        padding: 0.5rem 0.75rem;
    }
    /* Classe para ocultar o widget Select2 original */
    .hidden-select2-container {
        display: none !important;
    }
</style>
{% endblock %}


{% block content %}
<form method="post" novalidate>
    {% csrf_token %}

    <div class="sticky-top bg-light py-3 mb-4 border-bottom" style="top: -1px; z-index: 1020;">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2 mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-pencil-square text-primary"></i> Editar Processo
            </h1>
            <div>
                <a href="{{ processo.get_absolute_url }}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4"><i class="bi bi-check-lg me-1"></i> Salvar Alterações</button>
            </div>
        </div>
        {% if form.errors %}
            <div class="alert alert-danger alert-dismissible fade show small p-2 mt-2 mb-0" role="alert">
                <strong>Por favor, corrija os erros indicados nos campos abaixo.</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="padding: 0.75rem 1rem;"></button>
            </div>
        {% endif %}
    </div>

    <ul class="nav nav-tabs nav-fill" id="editProcessoTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral-pane" type="button" role="tab" aria-controls="geral-pane" aria-selected="true">
                <i class="bi bi-file-earmark-text me-1"></i> Geral
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tramite-tab" data-bs-toggle="tab" data-bs-target="#tramite-pane" type="button" role="tab" aria-controls="tramite-pane" aria-selected="false">
                <i class="bi bi-building-fill-gear me-1"></i> Trâmite e Juízo
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="acesso-tab" data-bs-toggle="tab" data-bs-target="#acesso-pane" type="button" role="tab" aria-controls="acesso-pane" aria-selected="false">
                <i class="bi bi-shield-lock me-1"></i> Equipe e Acesso
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="resultado-tab" data-bs-toggle="tab" data-bs-target="#resultado-pane" type="button" role="tab" aria-controls="resultado-pane" aria-selected="false">
                <i class="bi bi-gavel me-1"></i> Resultado e Execução
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="complementar-tab" data-bs-toggle="tab" data-bs-target="#complementar-pane" type="button" role="tab" aria-controls="complementar-pane" aria-selected="false">
                <i class="bi bi-three-dots me-1"></i> Complementar
            </button>
        </li>
    </ul>

    <div class="tab-content" id="editProcessoTabContent">

        <div class="tab-pane fade show active" id="geral-pane" role="tabpanel" aria-labelledby="geral-tab" tabindex="0">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="form-floating">
                                {{ form.tipo_acao }}
                                <label for="{{ form.tipo_acao.id_for_label }}">{{ form.tipo_acao.label }}</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                {{ form.numero_processo }}
                                <label for="{{ form.numero_processo.id_for_label }}">{{ form.numero_processo.label }}</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                {{ form.descricao_caso }}
                                <label for="{{ form.descricao_caso.id_for_label }}">{{ form.descricao_caso.label }}</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.data_distribuicao }}
                                <label for="{{ form.data_distribuicao.id_for_label }}">{{ form.data_distribuicao.label }}</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.valor_causa }}
                                <label for="{{ form.valor_causa.id_for_label }}">{{ form.valor_causa.label }}</label>
                            </div>
                        </div>
                        <div class="col-12 mt-4 pt-3 border-top">
                            <h6 class="text-muted mb-3">Opções</h6>
                            <div class="d-flex flex-wrap gap-4">
                                <div class="form-check form-switch">{{ form.segredo_justica }} {{ form.segredo_justica.label_tag }}</div>
                                <div class="form-check form-switch">{{ form.justica_gratuita }} {{ form.justica_gratuita.label_tag }}</div>
                                <div class="form-check form-switch">{{ form.prioridade_tramitacao }} {{ form.prioridade_tramitacao.label_tag }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tramite-pane" role="tabpanel" aria-labelledby="tramite-tab" tabindex="0">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                             <div class="form-floating">{{ form.status_processo }} <label for="{{ form.status_processo.id_for_label }}">{{ form.status_processo.label }}</label></div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">{{ form.fase }} <label for="{{ form.fase.id_for_label }}">{{ form.fase.label }}</label></div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">{{ form.grau_jurisdicao }} <label for="{{ form.grau_jurisdicao.id_for_label }}">{{ form.grau_jurisdicao.label }}</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">{{ form.tribunal }} <label for="{{ form.tribunal.id_for_label }}">{{ form.tribunal.label }}</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">{{ form.vara_comarca_orgao }} <label for="{{ form.vara_comarca_orgao.id_for_label }}">{{ form.vara_comarca_orgao.label }}</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">{{ form.juiz_responsavel }} <label for="{{ form.juiz_responsavel.id_for_label }}">{{ form.juiz_responsavel.label }}</label></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="acesso-pane" role="tabpanel" aria-labelledby="acesso-tab" tabindex="0">
            <div class="card shadow-sm">
                 <div class="card-body p-4">
                    <div class="mb-4">
                        <label for="{{ form.advogado_responsavel.id_for_label }}" class="form-label fw-bold">{{ form.advogado_responsavel.label }}</label>
                        {{ form.advogado_responsavel }}
                        <div class="form-text">O advogado responsável sempre terá acesso e não aparece na lista de seleção abaixo.</div>
                    </div>

                    <hr class="my-4">

                    <h6 class="text-muted">Outros Colaboradores</h6>
                    <p class="small">Adicione ou remova usuários que também podem visualizar e interagir com este processo.</p>

                    <div id="advogados_envolvidos_wrapper">
                        {{ form.advogados_envolvidos }}
                    </div>

                    <div class="dual-listbox-container mt-2">
                        <div class="dual-listbox-col">
                            <label for="disponiveis" class="form-label fw-bold text-center">Disponíveis</label>
                            <select multiple class="form-select dual-listbox-list" id="disponiveis"></select>
                        </div>

                        <div class="dual-listbox-controls">
                            <button type="button" class="btn btn-outline-primary" id="btn-add" title="Adicionar"><i class="bi bi-chevron-right"></i></button>
                            <button type="button" class="btn btn-outline-secondary" id="btn-remove" title="Remover"><i class="bi bi-chevron-left"></i></button>
                            <button type="button" class="btn btn-outline-primary mt-4" id="btn-add-all" title="Adicionar Todos"><i class="bi bi-chevron-double-right"></i></button>
                            <button type="button" class="btn btn-outline-secondary" id="btn-remove-all" title="Remover Todos"><i class="bi bi-chevron-double-left"></i></button>
                        </div>

                        <div class="dual-listbox-col">
                            <label for="selecionados" class="form-label fw-bold text-center">No Processo</label>
                            <select multiple class="form-select dual-listbox-list" id="selecionados"></select>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-top">
                        <h6 class="mb-2">Nível de Permissão de Visualização</h6>
                        {{ form.nivel_permissao }}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="resultado-pane" role="tabpanel" aria-labelledby="resultado-tab" tabindex="0">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-floating">{{ form.resultado }} <label for="{{ form.resultado.id_for_label }}">{{ form.resultado.label }}</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">{{ form.data_transito_em_julgado }} <label for="{{ form.data_transito_em_julgado.id_for_label }}">{{ form.data_transito_em_julgado.label }}</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">{{ form.valor_executado }} <label for="{{ form.valor_executado.id_for_label }}">{{ form.valor_executado.label }}</label></div>
                        </div>
                         <div class="col-12">
                            <div class="form-floating">{{ form.bloqueios_penhoras }} <label for="{{ form.bloqueios_penhoras.id_for_label }}">{{ form.bloqueios_penhoras.label }}</label></div>
                        </div>
                        <div class="col-12 mt-4 pt-3 border-top">
                           <div class="form-check form-switch">{{ form.execucao_iniciada }} {{ form.execucao_iniciada.label_tag }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="complementar-pane" role="tabpanel" aria-labelledby="complementar-tab" tabindex="0">
            <div class="card shadow-sm">
                 <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-floating">{{ form.observacoes_internas }} <label for="{{ form.observacoes_internas.id_for_label }}">{{ form.observacoes_internas.label }}</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">{{ form.numero_sei }} <label for="{{ form.numero_sei.id_for_label }}">{{ form.numero_sei.label }}</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">{{ form.numero_outro_sistema }} <label for="{{ form.numero_outro_sistema.id_for_label }}">{{ form.numero_outro_sistema.label }}</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">{{ form.link_acesso }} <label for="{{ form.link_acesso.id_for_label }}">{{ form.link_acesso.label }}</label></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const originalSelectId = '{{ form.advogados_envolvidos.id_for_label }}';
    const originalSelect = document.getElementById(originalSelectId);

    if (!originalSelect) {
        console.error('Elemento select original não encontrado:', originalSelectId);
        return;
    }

    const disponiveisList = document.getElementById('disponiveis');
    const selecionadosList = document.getElementById('selecionados');

    function inicializarDualListbox() {
        disponiveisList.innerHTML = '';
        selecionadosList.innerHTML = '';

        for (const option of originalSelect.options) {
            const newOption = option.cloneNode(true);
            if (option.selected) {
                selecionadosList.appendChild(newOption);
            } else {
                disponiveisList.appendChild(newOption);
            }
        }

        const wrapper = document.getElementById('advogados_envolvidos_wrapper');
        if (wrapper) {
            const select2Container = wrapper.querySelector('.select2-container');
            if (select2Container) {
                select2Container.classList.add('hidden-select2-container');
            }
        }
    }

    function moverOpcoes(origemList, destinoList, quais) {
        const opcoesParaMover = (quais === 'selecionadas') ? Array.from(origemList.selectedOptions) : Array.from(origemList.options);

        opcoesParaMover.forEach(option => {
            destinoList.appendChild(option);
            const originalOption = originalSelect.querySelector(`option[value="${option.value}"]`);
            if (originalOption) {
                originalOption.selected = (destinoList.id === 'selecionados');
            }
        });

        // Dispara o evento de 'change' no Select2 para que ele atualize seu estado interno
        if (typeof $ !== 'undefined') {
            $(originalSelect).trigger('change');
        }
    }

    // Atraso para garantir que o Select2 já tenha inicializado
    setTimeout(inicializarDualListbox, 200);

    document.getElementById('btn-add').addEventListener('click', () => moverOpcoes(disponiveisList, selecionadosList, 'selecionadas'));
    document.getElementById('btn-remove').addEventListener('click', () => moverOpcoes(selecionadosList, disponiveisList, 'selecionadas'));
    document.getElementById('btn-add-all').addEventListener('click', () => moverOpcoes(disponiveisList, selecionadosList, 'todas'));
    document.getElementById('btn-remove-all').addEventListener('click', () => moverOpcoes(selecionadosList, disponiveisList, 'todas'));
});
</script>
{% endblock %}