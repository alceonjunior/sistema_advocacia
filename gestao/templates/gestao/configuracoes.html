{# alceonjunior/sistema_advocacia/alceonjunior-sistema_advocacia-0c3a4ac427b496a4ce8c807f83646315111139bd/gestao/templates/gestao/configuracoes.html #}
{% extends 'gestao/base.html' %}
{% load static %}

{% block title %}Configurações do Sistema{% endblock %}

{% block styles %}
{{ block.super }}
<style>
    /* Estilos Gerais da Página de Configurações */
    :root {
        --sidebar-width: 280px;
    }

    .config-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .config-sidebar {
        flex: 0 0 var(--sidebar-width);
    }

    .config-main {
        flex: 1 1 calc(100% - var(--sidebar-width) - 1.5rem);
        min-width: 0;
    }

    @media (max-width: 991.98px) {
        .config-layout { flex-direction: column; }
        .config-sidebar { flex: 1 1 100%; }
    }

    /* Foco Visível para Acessibilidade */
    .nav-pills .nav-link:focus-visible,
    .list-group-item-action:focus-visible,
    .dropdown-item:focus-visible,
    .btn:focus-visible,
    .form-check-input:focus-visible {
        outline: 2px solid var(--bs-primary-border-subtle);
        outline-offset: 2px;
        box-shadow: 0 0 0 .25rem rgba(var(--bs-primary-rgb), .25);
    }

    /* Aba de Usuários: Dropdown e Cabeçalho Fixo */
    @media (min-width: 768px) {
        .table-responsive { overflow: visible; }
    }
    .table thead {
        position: sticky;
        top: 0;
        z-index: 1;
        background-color: var(--bs-table-bg);
    }

    /* Aba "Escritório": Preview da Logo */
    .logo-preview-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 220px;
        min-height: 140px;
        border: 2px dashed var(--bs-border-color-translucent);
        border-radius: .5rem;
        background-color: var(--bs-tertiary-bg);
        overflow: hidden;
        position: relative;
    }
    .logo-preview {
        max-width: 100%;
        max-height: 120px;
        object-fit: contain;
    }
    .logo-placeholder {
        text-align: center;
        color: var(--bs-secondary-color);
        font-size: 0.9em;
    }
    .logo-placeholder i {
        font-size: 2.5em;
        display: block;
        margin-bottom: 0.5rem;
    }

    /* Aba de Permissões: Estado de Carregamento */
    .permission-container {
        position: relative;
        transition: opacity 0.3s ease;
    }
    .permission-container.loading {
        opacity: 0.5;
        pointer-events: none;
    }
    .permission-container.loading::before {
        content: '';
        position: absolute;
        inset: 0;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 5;
    }
    .permission-container.loading::after {
        content: 'Carregando...';
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        padding: .5rem 1rem;
        background-color: var(--bs-primary);
        color: white;
        border-radius: .25rem;
        z-index: 10;
    }
    .permission-module {
        border: 1px solid var(--bs-border-color);
        border-radius: .375rem;
        margin-bottom: 1rem;
    }
    .permission-module-header {
        background-color: var(--bs-light);
        padding: .75rem 1rem;
        border-bottom: 1px solid var(--bs-border-color);
    }
    .permission-module-body {
        padding: 1rem 1rem 0.5rem 1rem;
    }

    /* Animações com respeito à preferência do usuário */
    @media (prefers-reduced-motion: no-preference) {
      .fade {
        transition: opacity .3s ease-out;
      }
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2">
        <i class="bi bi-gear-fill text-primary"></i> Configurações do Sistema
    </h1>
</div>

<div class="config-layout">
    <aside class="config-sidebar">
        <div class="list-group" id="config-list" role="tablist" aria-orientation="vertical">
            <a class="list-group-item list-group-item-action active" id="escritorio-tab" data-bs-toggle="list" href="#escritorio-pane" role="tab" aria-controls="escritorio-pane" aria-selected="true"><i class="bi bi-building me-2"></i>Dados do Escritório</a>
            <a class="list-group-item list-group-item-action" id="usuarios-tab" data-bs-toggle="list" href="#usuarios-pane" role="tab" aria-controls="usuarios-pane" aria-selected="false"><i class="bi bi-people-fill me-2"></i>Usuários</a>
            <a class="list-group-item list-group-item-action" id="cadastros-tab" data-bs-toggle="list" href="#cadastros-pane" role="tab" aria-controls="cadastros-pane" aria-selected="false"><i class="bi bi-tags-fill me-2"></i>Cadastros Auxiliares</a>
            <a class="list-group-item list-group-item-action" id="permissoes-tab" data-bs-toggle="list" href="#permissoes-pane" role="tab" aria-controls="permissoes-pane" aria-selected="false"><i class="bi bi-shield-lock-fill me-2"></i>Permissões</a>
        </div>
    </aside>

    <main class="config-main">
        <div class="tab-content">

            <div class="tab-pane fade show active" id="escritorio-pane" role="tabpanel" aria-labelledby="escritorio-tab">
                <form method="post" enctype="multipart/form-data" id="escritorioConfigForm">
                    {% csrf_token %}
                    <input type="hidden" name="salvar_escritorio" value="1">
                    <div class="card shadow-sm">
                        <div class="card-header"><h5 class="mb-0">Informações do Escritório</h5></div>
                        <div class="card-body p-4">

                            <h6 class="text-primary">LOGO DO ESCRITÓRIO</h6><hr class="mt-1 mb-3">
                            <div class="mb-4">
                                <div class="mb-3">
                                    <label class="form-label d-block">Pré-visualização:</label>
                                    <div class="logo-preview-wrapper">
                                        <img src="" alt="Logo atual do Escritório" class="logo-preview d-none" id="logoPreviewImg" data-initial-url="{% if configuracao_escritorio.logo %}{{ configuracao_escritorio.logo.url }}{% endif %}">
                                        <div class="logo-placeholder" id="logoPlaceholder"><i class="bi bi-image"></i><span>Nenhuma logo definida</span></div>
                                    </div>
                                    <div id="logo-status-announcer" class="visually-hidden" aria-live="polite"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form_escritorio.logo.id_for_label }}" class="form-label">Carregar / Alterar Logo:</label>
                                    {{ form_escritorio.logo }}
                                    <small class="form-text text-muted">Formatos recomendados: PNG, JPG. Tamanho máximo: 2MB.</small>
                                </div>
                                <div id="removeLogoButtonContainer" class="mt-3 d-none">
                                    <input type="checkbox" name="{{ form_escritorio.logo.html_name }}-clear" id="{{ form_escritorio.logo.id_for_label }}-clear" class="d-none">
                                    <button type="button" id="removeLogoButton" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmRemoveLogoModal">
                                        <i class="bi bi-trash-fill me-1"></i> Remover Logo Atual
                                    </button>
                                </div>
                            </div>

                            <h6 class="text-primary mt-4">IDENTIFICAÇÃO</h6><hr class="mt-1 mb-3">
                            <div class="row g-3">
                                <div class="col-md-8">{{ form_escritorio.nome_escritorio.label_tag }}{{ form_escritorio.nome_escritorio }}</div>
                                <div class="col-md-4">{{ form_escritorio.cnpj.label_tag }}{{ form_escritorio.cnpj }}</div>
                                <div class="col-md-4">{{ form_escritorio.oab_principal.label_tag }}{{ form_escritorio.oab_principal }}</div>
                            </div>

                            <h6 class="text-primary mt-4">ENDEREÇO</h6><hr class="mt-1 mb-3">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form_escritorio.cep.id_for_label }}">{{ form_escritorio.cep.label }}</label>
                                    <div class="input-group">{{ form_escritorio.cep }}<button class="btn btn-outline-secondary" type="button" id="btn-buscar-cep"><i class="bi bi-search"></i></button></div>
                                </div>
                                <div class="col-md-8">{{ form_escritorio.logradouro.label_tag }}{{ form_escritorio.logradouro }}</div>
                                <div class="col-md-4">{{ form_escritorio.numero.label_tag }}{{ form_escritorio.numero }}</div>
                                <div class="col-md-8">{{ form_escritorio.complemento.label_tag }}{{ form_escritorio.complemento }}</div>
                                <div class="col-md-6">{{ form_escritorio.bairro.label_tag }}{{ form_escritorio.bairro }}</div>
                                <div class="col-md-4">{{ form_escritorio.cidade.label_tag }}{{ form_escritorio.cidade }}</div>
                                <div class="col-md-2">{{ form_escritorio.estado.label_tag }}{{ form_escritorio.estado }}</div>
                            </div>

                            <h6 class="text-primary mt-4">CONTATO</h6><hr class="mt-1 mb-3">
                            <div class="row g-3">
                                <div class="col-md-6">{{ form_escritorio.telefone_contato.label_tag }}{{ form_escritorio.telefone_contato }}</div>
                                <div class="col-md-6">{{ form_escritorio.email_contato.label_tag }}{{ form_escritorio.email_contato }}</div>
                            </div>
                        </div>
                        <div class="card-footer text-end"><button type="submit" class="btn btn-primary"><i class="bi bi-check-circle-fill me-1"></i> Salvar Configurações</button></div>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="usuarios-pane" role="tabpanel" aria-labelledby="usuarios-tab">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Gerenciamento de Usuários</h5>
                        <a href="{% url 'gestao:adicionar_usuario' %}" class="btn btn-primary btn-sm"><i class="bi bi-person-plus-fill me-1"></i> Adicionar Usuário</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome Completo</th>
                                    <th>Email</th>
                                    <th>Grupos/Cargos</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios %}
                                <tr>
                                    <td class="fw-bold">{{ usuario.get_full_name|default:usuario.username }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>{% for group in usuario.groups.all %}<span class="badge bg-secondary fw-normal">{{ group.name }}</span>{% empty %}<span class="text-muted small">Nenhum</span>{% endfor %}</td>
                                    <td class="text-center">
                                        {% if usuario.is_active %}<span class="badge bg-success-subtle text-success-emphasis rounded-pill">Ativo</span>{% else %}<span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Inativo</span>{% endif %}
                                    </td>
                                    <td class="text-end">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Ações</button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" href="{% url 'gestao:editar_usuario' user_id=usuario.pk %}"><i class="bi bi-pencil-fill me-2"></i>Editar</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <form action="{% url 'gestao:ativar_desativar_usuario' user_id=usuario.pk %}" method="post" class="d-inline">
                                                        {% csrf_token %}
                                                        <button type="submit" class="dropdown-item {% if not usuario.is_active %}text-success{% else %}text-danger{% endif %}">
                                                            {% if usuario.is_active %}<i class="bi bi-toggle-off me-2"></i>Desativar{% else %}<i class="bi bi-toggle-on me-2"></i>Ativar{% endif %}
                                                        </button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if usuarios.has_other_pages %}<div class="card-footer">{% include 'gestao/partials/_paginacao.html' with page_obj=usuarios %}</div>{% endif %}
                </div>
            </div>

            <div class="tab-pane fade" id="cadastros-pane" role="tabpanel" aria-labelledby="cadastros-tab">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <ul class="nav nav-pills card-header-pills" id="cadastros-auxiliares-tabs" role="tablist">
                            <li class="nav-item" role="presentation"><a class="nav-link active" id="tipos-servico-subtab" data-bs-toggle="tab" href="#tipos-servico-subpane" role="tab" aria-controls="tipos-servico-subpane" aria-selected="true">Tipos de Serviço</a></li>
                            <li class="nav-item" role="presentation"><a class="nav-link" id="areas-processo-subtab" data-bs-toggle="tab" href="#areas-processo-subpane" role="tab" aria-controls="areas-processo-subpane" aria-selected="false">Áreas do Direito</a></li>
                            <li class="nav-item" role="presentation"><a class="nav-link" id="tipos-acao-subtab" data-bs-toggle="tab" href="#tipos-acao-subpane" role="tab" aria-controls="tipos-acao-subpane" aria-selected="false">Tipos de Ação</a></li>
                            <li class="nav-item" role="presentation"><a class="nav-link" id="tipos-mov-subtab" data-bs-toggle="tab" href="#tipos-mov-subpane" role="tab" aria-controls="tipos-mov-subpane" aria-selected="false">Tipos de Movimentação</a></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content p-3">
                            <div class="tab-pane fade show active" id="tipos-servico-subpane" role="tabpanel" aria-labelledby="tipos-servico-subtab">
                                {% include 'gestao/partials/_cadastro_auxiliar_item.html' with titulo="Tipos de Serviço" form=form_tipo_servico itens=tipos_servico modelo="TipoServico" %}
                            </div>
                            <div class="tab-pane fade" id="areas-processo-subpane" role="tabpanel" aria-labelledby="areas-processo-subtab">
                                {% include 'gestao/partials/_cadastro_auxiliar_item.html' with titulo="Áreas do Direito" form=form_area_processo itens=areas_processo modelo="AreaProcesso" %}
                            </div>
                            <div class="tab-pane fade" id="tipos-acao-subpane" role="tabpanel" aria-labelledby="tipos-acao-subtab">
                                {% include 'gestao/partials/_cadastro_tipo_acao.html' with titulo="Tipos de Ação" form=form_tipo_acao itens=tipos_acao modelo="TipoAcao" areas_processo=areas_processo %}
                            </div>
                            <div class="tab-pane fade" id="tipos-mov-subpane" role="tabpanel" aria-labelledby="tipos-mov-subtab">
                                {% include 'gestao/partials/_cadastro_tipo_movimentacao.html' with titulo="Tipos de Movimentação" form=form_tipo_movimentacao itens=tipos_movimentacao modelo="TipoMovimentacao" %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="permissoes-pane" role="tabpanel" aria-labelledby="permissoes-tab">
                 <div class="card shadow-sm">
                    <div class="card-header"><h5 class="mb-0">Gerenciar Permissões de Grupo</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="group_select" class="form-label">Selecione um grupo para editar suas permissões:</label>
                            <select id="group_select" class="form-select"><option value="">Selecione um Grupo...</option>{% for group in grupos %}<option value="{{ group.id }}">{{ group.name }}</option>{% endfor %}</select>
                        </div>
                        <form id="group_permissions_form" method="post" action="" style="display: none;">
                            {% csrf_token %}
                            <div class="permission-container" id="permission-container">
                                {% for module, perms in permissoes_estruturadas.items %}
                                <div class="permission-module">
                                    <div class="permission-module-header d-flex justify-content-between align-items-center">
                                        <strong class="text-primary">{{ module }}</strong>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input master-checkbox" type="checkbox" data-module="{{ module|slugify }}">
                                            <label class="form-check-label small">Marcar todos</label>
                                        </div>
                                    </div>
                                    <div class="permission-module-body">
                                        {% for perm in perms %}
                                        <div class="form-check">
                                            <input class="form-check-input permission-checkbox" type="checkbox" name="permissoes" value="{{ perm.id }}" id="permission_{{ perm.id }}" data-module="{{ module|slugify }}">
                                            <label class="form-check-label" for="permission_{{ perm.id }}">{{ perm.label }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="submit" class="btn btn-primary mt-3"><i class="bi bi-save-fill me-1"></i> Salvar Permissões</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="confirmRemoveLogoModal" tabindex="-1" aria-labelledby="confirmRemoveLogoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="confirmRemoveLogoModalLabel">Confirmar Remoção</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">Deseja remover a logo atual? A alteração será efetivada ao salvar.</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveLogoBtn">Sim, Remover</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LÓGICA DA ABA DE ESCRITÓRIO E PERMISSÕES (sem alterações) ---
    // ...

    // =======================================================
    // === JAVASCRIPT CORRIGIDO PARA CADASTROS AUXILIARES ====
    // =======================================================
    const cadastrosTab = document.getElementById('cadastros-pane');
    if (cadastrosTab) {

        // Função unificada para tratar a resposta do servidor
        const handleServerResponse = (form, responseData) => {
            const errorDiv = form.querySelector('.ajax-error');
            if (errorDiv) {
                errorDiv.innerHTML = '';
                errorDiv.classList.add('d-none');
            }

            if (responseData.status === 'success') {
                const listContainer = form.closest('.tab-pane').querySelector('.list-group-container');
                const noItemsMessage = listContainer.querySelector('.no-items-message');
                if(noItemsMessage) noItemsMessage.remove();

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = responseData.item_html;
                const newItemElement = tempDiv.firstChild;

                if (responseData.is_new) { // Adicionar novo item
                    const targetList = listContainer.querySelector('.list-group, ul');
                    if(targetList) targetList.appendChild(newItemElement);
                    form.reset();
                    const areaSelect = form.querySelector('select');
                    if(areaSelect) areaSelect.selectedIndex = 0;
                } else { // Atualizar item existente
                    const pk = responseData.pk;
                    const existingItem = listContainer.querySelector(`[data-pk="${pk}"]`);
                    if (existingItem) {
                        existingItem.replaceWith(newItemElement);
                    }
                }
            } else if (errorDiv && responseData.errors) {
                const errorMessages = Object.values(responseData.errors).flat().map(e => e.message || e);
                errorDiv.innerHTML = errorMessages.join('<br>');
                errorDiv.classList.remove('d-none');
            } else {
                alert(responseData.message || 'Ocorreu um erro desconhecido.');
            }
        };

        // Delegação de evento para submissão de formulários
        cadastrosTab.addEventListener('submit', function(event) {
            if (event.target.matches('.form-add-item, .form-edit-item')) {
                event.preventDefault();
                const form = event.target;
                const submitButton = form.querySelector('button[type="submit"], .btn-save-edit');
                if (submitButton) submitButton.disabled = true;

                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => handleServerResponse(form, data))
                .catch(error => console.error('Erro no fetch:', error))
                .finally(() => {
                    if (submitButton) submitButton.disabled = false;
                });
            }
        });

        // Delegação de evento para cliques nos botões (editar, cancelar, excluir)
        cadastrosTab.addEventListener('click', function(event) {
            const target = event.target;
            const itemElement = target.closest('.list-group-item');
            if (!itemElement) return;

            if (target.closest('.btn-edit-item')) {
                itemElement.querySelector('.item-display').style.display = 'none';
                itemElement.querySelector('.item-actions').style.display = 'none';
                itemElement.querySelector('.item-edit').style.display = 'flex';
            }

            if (target.closest('.btn-cancel-edit')) {
                itemElement.querySelector('.item-display').style.display = 'block';
                itemElement.querySelector('.item-actions').style.display = 'block';
                itemElement.querySelector('.item-edit').style.display = 'none';
            }

            if (target.closest('.btn-delete-item')) {
                if (confirm('Tem certeza que deseja excluir este item?')) {
                    const deleteButton = target.closest('.btn-delete-item');
                    fetch(deleteButton.dataset.url, {
                        method: 'POST',
                        headers: {'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest'}
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            itemElement.remove();
                        } else {
                            alert(data.message || 'Erro ao excluir.');
                        }
                    });
                }
            }
        });
    }
});
</script>
{% endblock %}