{% extends 'gestao/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Importador Inteligente do Projudi{% endblock %}

{% block styles %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    /* Estilos para aprimorar a UX/UI */
    .card-header {
        background-color: #f8f9fa;
        font-weight: 500;
    }
    .loading-overlay {
        position: absolute;
        inset: 0; /* Equivalente a top:0, left:0, right:0, bottom:0 */
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: var(--bs-card-inner-border-radius);
    }
    .preview-card {
        transition: box-shadow 0.2s ease-in-out;
    }
    .preview-card:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.10)!important;
    }
    .action-toggle-group {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    .select2-container--bootstrap-5 .select2-selection {
        font-size: 0.875rem; /* Deixa o select2 do mesmo tamanho dos inputs sm */
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 d-flex align-items-center gap-2">
        <i class="bi bi-cloud-upload-fill text-primary"></i> Importador Inteligente do Projudi
    </h1>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <i class="bi bi-1-circle-fill me-1"></i> Forneça os Dados
            </div>
            <div class="card-body p-4">
                <p class="text-muted">Importe os dados do Projudi de uma das formas abaixo para iniciar a análise.</p>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button type="button" id="btn-selecionar-arquivo" class="btn btn-primary fw-bold">
                        <i class="bi bi-file-earmark-arrow-up me-1"></i> Selecionar Arquivo JSON
                    </button>
                    <button type="button" id="btn-importar-clipboard" class="btn btn-secondary fw-bold">
                        <i class="bi bi-clipboard-check me-1"></i> Importar da Área de Transferência
                    </button>
                </div>
                <input type="file" id="file-input" accept=".json" class="d-none">
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <i class="bi bi-2-circle-fill me-1"></i> Revise e Confirme a Importação
            </div>
            <div class="card-body p-lg-4 p-3">
                <div id="preview-container">
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-clock-history fs-2 mb-3"></i>
                        <p>Aguardando dados para análise...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="processos-options-template">
    <option value="">Selecione um processo...</option>
    {% for p in todos_processos %}
    <option value="{{ p.pk }}">Proc. {{ p.numero_processo|default:"[S/N]" }} - {{ p.get_cliente_principal_display }} ({{ p.descricao_caso|truncatechars:30 }})</option>
    {% endfor %}
</template>

{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    const fileInput = $('#file-input');
    const previewContainer = $('#preview-container');
    // Armazena o conteúdo do molde de processos em uma variável para reuso rápido
    const processosOptionsHtml = $('#processos-options-template').html();

    /**
     * Função para inicializar os plugins (Select2) e popular os seletores de processo no conteúdo dinâmico.
     */
    function initializeDynamicComponents() {
        // Inicializa os seletores de cliente (cuja lista vem do AJAX)
        previewContainer.find('.select2-cliente').select2({
            theme: "bootstrap-5",
            width: '100%',
            placeholder: 'Busque por um cliente...'
        });

        // Popula e inicializa os seletores de processo usando o molde pré-carregado da página
        previewContainer.find('.select2-processo').each(function() {
            $(this).html(processosOptionsHtml); // Popula com as opções
            $(this).select2({
                theme: "bootstrap-5",
                width: '100%',
                placeholder: 'Busque por um processo...'
            });
        });
    }

    /**
     * Função central que detecta o tipo de JSON e dispara a análise via AJAX.
     * @param {string} jsonText - O conteúdo JSON a ser analisado.
     */
    function analisarDados(jsonText) {
        if (!jsonText) {
            alert('Nenhum dado JSON para analisar.');
            return;
        }
        try {
            const data = JSON.parse(jsonText);
            if (!Array.isArray(data) || data.length === 0) {
                alert('O JSON está vazio ou não é um formato de lista esperado.');
                return;
            }

            let importType = 'unknown';
            if ('tipoAudiencia' in data[0]) {
                importType = 'audiencias';
            } else if ('parteIntimada' in data[0]) {
                importType = 'movimentacoes';
            }

            if (importType === 'unknown') {
                alert('Não foi possível identificar o tipo do arquivo JSON (audiência ou prazos).');
                return;
            }

            $.ajax({
                url: "{% url 'gestao:analisar_dados_projudi_ajax' %}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ type: importType, payload: data }),
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                beforeSend: function() {
                    previewContainer.parent().append(
                        '<div class="loading-overlay"><div class="spinner-border text-primary" role="status"></div></div>'
                    );
                },
                success: function(response) {
                    if (response.status === 'success') {
                        previewContainer.html(response.html_preview);
                        // Chama a inicialização dos componentes após o novo HTML ser inserido
                        initializeDynamicComponents();
                    } else {
                        previewContainer.html(`<div class="alert alert-danger">${response.message || 'Ocorreu um erro na análise.'}</div>`);
                    }
                },
                error: function(xhr) {
                     const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Ocorreu um erro de comunicação com o servidor.';
                    previewContainer.html(`<div class="alert alert-danger">${errorMsg}</div>`);
                },
                complete: function() {
                    previewContainer.parent().find('.loading-overlay').remove();
                }
            });
        } catch (error) {
            alert('O conteúdo fornecido não é um JSON válido.');
            console.error(error);
        }
    }

    // --- EVENTOS DOS BOTÕES DE IMPORTAÇÃO ---
    $('#btn-selecionar-arquivo').on('click', () => fileInput.click());

    fileInput.on('change', function() {
        if (this.files.length) {
            const reader = new FileReader();
            reader.onload = (e) => analisarDados(e.target.result);
            reader.readAsText(this.files[0]);
        }
    });

    $('#btn-importar-clipboard').on('click', async () => {
        try {
            const clipboardText = await navigator.clipboard.readText();
            if (clipboardText) {
                analisarDados(clipboardText);
            } else {
                alert('A sua área de transferência está vazia.');
            }
        } catch (err) {
            alert('Não foi possível ler da área de transferência. Verifique as permissões do seu navegador.');
        }
    });

    // --- DELEGAÇÃO DE EVENTOS PARA A ÁREA DE REVISÃO DINÂMICA ---
    previewContainer.on('submit', '#form-import', function(e) {
        e.preventDefault();
        const form = $(this);
        const submitButton = form.find('button[type="submit"]');
        $.ajax({
            url: "{% url 'gestao:processar_importacao_projudi' %}",
            type: 'POST',
            data: form.serialize(),
            beforeSend: () => submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Importando...'),
            success: function(response) {
                if (response.status === 'success') {
                    previewContainer.html(`
                        <div class="text-center p-5">
                            <i class="bi bi-check-circle-fill fs-1 text-success"></i>
                            <h4 class="mt-3">Importação Concluída!</h4>
                            <p>Os dados selecionados foram adicionados ou atualizados no sistema com sucesso.</p>
                            <a href="{{ request.path }}" class="btn btn-primary mt-3">Fazer Nova Importação</a>
                        </div>`);
                } else {
                    alert(response.message || 'Ocorreu um erro desconhecido.');
                }
            },
            error: (xhr) => alert(xhr.responseJSON ? xhr.responseJSON.message : 'Erro de comunicação ao salvar.'),
            complete: () => submitButton.prop('disabled', false).html('<i class="bi bi-check-all me-1"></i> Confirmar e Importar Selecionados')
        });
    });

    previewContainer.on('change', '#selecionar-todos-switch', function() {
        previewContainer.find('.import-checkbox').prop('checked', $(this).prop('checked'));
    });

    // Lógica para alternar a exibição dos campos de edição/vinculação
    previewContainer.on('change', '.action-toggle', function() {
        if ($(this).prop('checked')) {
            const parentGroup = $(this).closest('.action-toggle-group');
            // Encontra e esconde todos os containers de ação dentro do mesmo grupo
            parentGroup.find('.action-container').slideUp(200);
            // Mostra apenas o container alvo da opção selecionada
            const targetSelector = $(this).data('target');
            parentGroup.find(targetSelector).slideDown(200);
        }
    });
});
</script>
{% endblock %}